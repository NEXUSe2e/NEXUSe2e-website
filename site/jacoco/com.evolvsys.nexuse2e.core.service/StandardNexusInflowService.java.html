<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StandardNexusInflowService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.service</a> &gt; <span class="el_source">StandardNexusInflowService.java</span></div><h1>StandardNexusInflowService.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.service;

import com.evolvsys.app.core.exception.ErrorCodeException;
import com.evolvsys.common.mdc.MDCIdGenerator;
import com.evolvsys.common.mdc.MDCService;
import com.evolvsys.nexuse2e.core.constants.ServiceConstants;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.exception.NexusRuntimeException;
import com.evolvsys.nexuse2e.core.logging.MessageLogContext;
import com.evolvsys.nexuse2e.core.logging.MessageLogContextHolder;
import com.evolvsys.nexuse2e.core.logging.service.LoggingCleanupService;
import com.evolvsys.nexuse2e.core.message.context.MessageContext;
import com.evolvsys.nexuse2e.core.utils.ErrorUtils;
import com.evolvsys.nexuse2e.internal.Message;
import com.evolvsys.nexuse2e.internal.MessageType;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.util.List;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.springframework.lang.Nullable;

/**
 * @author SvenBarden
 * @since 13.10.2023
 */
<span class="fc" id="L27">@Slf4j</span>
<span class="fc" id="L28">public abstract class StandardNexusInflowService extends BaseInflowNexusService {</span>

    @Nullable
    protected abstract List&lt;MessageContext&gt; buildMessageContexts() throws NexusException;

    protected Message createErrorMessage(MessageContext messageContext, ErrorCodeException errorCodeException) {
<span class="fc" id="L34">        Message errorMessage = new Message();</span>
<span class="fc" id="L35">        errorMessage.setType(MessageType.ERROR);</span>
<span class="fc" id="L36">        errorMessage.setId(messageContext.getMessageIdGenerator().generateId());</span>
<span class="fc" id="L37">        errorMessage.setReferenceMessageId(messageContext.getSourceMessage().getId());</span>
<span class="fc" id="L38">        errorMessage.setConversationId(messageContext.getSourceMessage().getConversationId());</span>

<span class="fc" id="L40">        return errorMessage;</span>
    }

    protected &lt;T extends Exception &amp; ErrorCodeException&gt; MessageContext handleResolverError(
            MessageContext messageContext, T errorCodeException) throws NexusException {
<span class="fc bfc" id="L45" title="All 2 branches covered.">        if (errorMessageResolver != null) {</span>
<span class="fc" id="L46">            messageContext.setErrorMessage(createErrorMessage(messageContext, errorCodeException));</span>
<span class="fc" id="L47">            messageContext = errorMessageResolver.resolve(messageContext);</span>
        }
<span class="fc" id="L49">        return messageContext;</span>
    }

    protected void afterResolving(MessageContext messageContext) {
<span class="fc" id="L53">        messageContext.getSourceMessage().setSourceComponent(getComponentId());</span>
<span class="fc" id="L54">    }</span>

    @SuppressFBWarnings(&quot;ACEM_ABSTRACT_CLASS_EMPTY_METHODS&quot;)
    protected void onSuccessfulDispatch(MessageContext messageContext) throws NexusException {
        // no default implementation
<span class="fc" id="L59">    }</span>

    protected MessageContext dispatch(MessageContext messageContext) throws NexusException {
<span class="fc bfc" id="L62" title="All 2 branches covered.">        if (messageDispatcher == null) {</span>
<span class="fc" id="L63">            throw new NexusException(NexusError.builder()</span>
<span class="fc" id="L64">                    .message(&quot;No message dispatcher in service&quot;)</span>
<span class="fc" id="L65">                    .extension(&quot;name&quot;, getServiceId())</span>
<span class="fc" id="L66">                    .extension(&quot;componentId&quot;, getComponentId())</span>
<span class="fc" id="L67">                    .build());</span>
        }
<span class="fc" id="L69">        messageContext = messageDispatcher.dispatch(messageContext);</span>
<span class="fc bfc" id="L70" title="All 4 branches covered.">        if (messageContext.getReturnMessage() != null &amp;&amp; returnMessageResolver != null) {</span>
<span class="fc" id="L71">            messageContext = returnMessageResolver.resolve(messageContext);</span>
        }

<span class="fc" id="L74">        return messageContext;</span>
    }

    protected void execute(MessageContext messageContext) throws NexusException {
        try {
<span class="fc" id="L79">            messageContext</span>
<span class="fc" id="L80">                    .getSourceMessage()</span>
<span class="fc" id="L81">                    .getMetaData()</span>
<span class="fc" id="L82">                    .set(ServiceConstants.SourceService.CATEGORY, ServiceConstants.SERVICE_ID, getServiceId())</span>
<span class="fc" id="L83">                    .set(ServiceConstants.SourceService.CATEGORY, ServiceConstants.COMPONENT_ID, getComponentId());</span>

<span class="fc" id="L85">            LOGGER.trace(&quot;calling messageResolver for service {}&quot;, getServiceId());</span>
<span class="fc" id="L86">            messageContext = messageResolver.resolve(messageContext);</span>

<span class="fc" id="L88">            afterResolving(messageContext);</span>

<span class="fc" id="L90">            messageContext.getSourceData().clear();</span>
<span class="fc" id="L91">            messageContext.getMetaData().clear();</span>

<span class="fc" id="L93">            LOGGER.trace(</span>
                    &quot;dispatching message {} for service {}&quot;,
<span class="fc" id="L95">                    messageContext.getSourceMessage().getId(),</span>
<span class="fc" id="L96">                    getServiceId());</span>
<span class="fc" id="L97">            dispatch(messageContext);</span>

<span class="fc" id="L99">            onSuccessfulDispatch(messageContext);</span>
<span class="fc" id="L100">        } catch (NexusRuntimeException | NexusException e) {</span>
<span class="fc" id="L101">            LOGGER.debug(</span>
                    &quot;handling exception for message {}&quot;,
<span class="fc" id="L103">                    messageContext.getSourceMessage().getId());</span>
<span class="fc" id="L104">            messageContext = handleResolverError(messageContext, e);</span>

<span class="fc bfc" id="L106" title="All 2 branches covered.">            if (messageContext.getErrorMessage() == null) {</span>
<span class="fc" id="L107">                LOGGER.trace(&quot;no error message created, throw exception for default handling&quot;, e);</span>
<span class="fc" id="L108">                throw e;</span>
            } else {
<span class="fc" id="L110">                LOGGER.error(&quot;error resolving message: {}&quot;, ErrorUtils.aggregate(e), e);</span>
            }
<span class="fc" id="L112">        }</span>
<span class="fc" id="L113">    }</span>

    @Override
    public void execute() throws NexusException {
<span class="fc" id="L117">        List&lt;MessageContext&gt; messageContexts = buildMessageContexts();</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (CollectionUtils.isEmpty(messageContexts)) {</span>
<span class="fc" id="L119">            LOGGER.trace(&quot;no message context created&quot;);</span>
        } else {
<span class="fc" id="L121">            LOGGER.trace(&quot;created {} message contexts&quot;, messageContexts.size());</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">            boolean updateMdcId = messageContexts.size() &gt; 1;</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">            for (MessageContext messageContext : messageContexts) {</span>
<span class="pc bpc" id="L124" title="1 of 4 branches missed.">                if (messageContext == null || messageContext.getSourceMessage() == null) {</span>
<span class="fc" id="L125">                    LOGGER.trace(&quot;message context is null or has no message, skip resolving&quot;);</span>
                } else {
<span class="fc" id="L127">                    MDCService mdcService = messageContext.getBeanFactory().getBean(MDCService.class);</span>
<span class="fc" id="L128">                    MDCIdGenerator mdcIdGenerator =</span>
<span class="fc" id="L129">                            messageContext.getBeanFactory().getBean(MDCIdGenerator.class);</span>
<span class="fc" id="L130">                    String originalMdcId = mdcService.getId();</span>
<span class="fc" id="L131">                    String newMdcId = mdcIdGenerator.newId();</span>
                    try {
<span class="fc bfc" id="L133" title="All 2 branches covered.">                        if (updateMdcId) {</span>
<span class="fc" id="L134">                            mdcService.setId(newMdcId);</span>
<span class="fc" id="L135">                            LOGGER.trace(&quot;set mdcId from {} to {} for message processing&quot;, originalMdcId, newMdcId);</span>
                        }

<span class="fc" id="L138">                        MessageLogContext context = MessageLogContextHolder.createEmptyContext();</span>
<span class="fc" id="L139">                        context.setMessageContext(messageContext);</span>
<span class="fc" id="L140">                        MessageLogContextHolder.setContext(context);</span>

<span class="fc" id="L142">                        execute(messageContext);</span>
                    } finally {
<span class="fc" id="L144">                        MessageLogContextHolder.clearContext();</span>
<span class="fc" id="L145">                        LOGGER.trace(&quot;cleared message log context&quot;);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">                        if (updateMdcId) {</span>
<span class="fc" id="L147">                            mdcService.setId(originalMdcId);</span>
<span class="fc" id="L148">                            LOGGER.trace(&quot;set mdcId to old value {} from {}&quot;, originalMdcId, newMdcId);</span>
                        }

<span class="fc" id="L151">                        LoggingCleanupService loggingCleanupService =</span>
<span class="fc" id="L152">                                messageContext.getBeanFactory().getBean(LoggingCleanupService.class);</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">                        loggingCleanupService.updateLogs(messageContext, updateMdcId ? newMdcId : originalMdcId);</span>
                    }
                }
<span class="fc" id="L156">            }</span>
        }
<span class="fc" id="L158">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>