<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserConfigHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.config.handler</a> &gt; <span class="el_source">UserConfigHandler.java</span></div><h1>UserConfigHandler.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.config.handler;

import com.evolvsys.app.core.role.model.RoleEntity;
import com.evolvsys.app.core.role.repository.RoleRepository;
import com.evolvsys.app.core.tenant.model.TenantRoleEntity;
import com.evolvsys.app.core.tenant.repository.TenantRepository;
import com.evolvsys.app.core.tenant.repository.TenantRoleRepository;
import com.evolvsys.app.core.user.model.UserEntity;
import com.evolvsys.nexuse2e.core.config.handler.mapper.UserConfigMapper;
import com.evolvsys.nexuse2e.core.config.model.ConfigContext;
import com.evolvsys.nexuse2e.core.config.model.ConfigExportContext;
import com.evolvsys.nexuse2e.core.config.model.NexusConfig;
import com.evolvsys.nexuse2e.core.config.model.UserConfig;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusRuntimeException;
import com.evolvsys.nexuse2e.core.user.repository.CustomUserRepository;
import java.time.ZonedDateTime;
import java.util.*;
import java.util.function.Function;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.collections4.ComparatorUtils;
import org.apache.commons.collections4.comparators.NullComparator;
import org.apache.commons.collections4.comparators.TransformingComparator;
import org.apache.commons.lang3.ObjectUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.data.domain.Example;
import org.springframework.data.domain.ExampleMatcher;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

/**
 * @author Florian Drees
 * @since 11.03.2024
 */
@Component
@RequiredArgsConstructor
<span class="fc" id="L39">@Slf4j</span>
public class UserConfigHandler implements ConfigHandler&lt;UserConfig&gt; {
<span class="fc" id="L41">    private static final Long SYSTEM_TENANT_ID = 1L;</span>

    private final CustomUserRepository userRepository;
    private final UserConfigMapper userConfigMapper;
    private final TenantRoleRepository tenantRoleRepository;
    private final RoleRepository roleRepository;
    private final TenantRepository tenantRepository;

    private UserEntity create() {
<span class="fc" id="L50">        return new UserEntity();</span>
    }

    @Override
    public void clear() {
<span class="fc" id="L55">        userRepository.findAll().forEach(userEntity -&gt; {</span>
<span class="fc" id="L56">            userEntity.setDeleted(ZonedDateTime.now());</span>
<span class="fc" id="L57">            userEntity.setUserName(null);</span>
<span class="fc" id="L58">            userRepository.save(userEntity);</span>
<span class="fc" id="L59">        });</span>
<span class="fc" id="L60">    }</span>

    private Optional&lt;UserEntity&gt; findUserByName(String userName) {
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">        return StringUtils.isBlank(userName) ? Optional.empty() : userRepository.findByUserName(userName);</span>
    }

    private Optional&lt;UserEntity&gt; findUserByEmail(String email) {
<span class="fc bfc" id="L67" title="All 2 branches covered.">        return StringUtils.isBlank(email) ? Optional.empty() : userRepository.findByEmail(email);</span>
    }

    @Override
    @Transactional
    public void importConfig(ConfigContext configContext, UserConfig config) {
<span class="fc" id="L73">        LOGGER.trace(&quot;handling user with username {} and email {}&quot;, config.getUserName(), config.getEmail());</span>

<span class="fc" id="L75">        UserEntity userEntity = findUserByName(config.getUserName())</span>
<span class="fc" id="L76">                .or(() -&gt; findUserByEmail(config.getEmail()))</span>
<span class="fc" id="L77">                .orElseGet(this::create);</span>

<span class="pc bpc" id="L79" title="1 of 2 branches missed.">        if (userEntity.getDeleted() != null) {</span>
<span class="nc" id="L80">            LOGGER.debug(&quot;reactivating deleted user with username {}&quot;, config.getUserName());</span>
<span class="nc" id="L81">            userEntity.setDeleted(null);</span>
        }

<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (userEntity.getId() != null) {</span>
<span class="nc" id="L85">            tenantRoleRepository.deleteAllInBatch(tenantRoleRepository.findByUser_id(userEntity.getId()));</span>
        }

<span class="fc" id="L88">        userConfigMapper.updateEntity(config, userEntity);</span>
<span class="fc" id="L89">        userRepository.save(userEntity);</span>

<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (CollectionUtils.isNotEmpty(config.getRoles())) {</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">            for (String role : config.getRoles()) {</span>
<span class="fc" id="L93">                RoleEntity search = new RoleEntity();</span>
<span class="fc" id="L94">                search.setInternalName(role);</span>
<span class="fc" id="L95">                RoleEntity roleEntity = roleRepository</span>
<span class="fc" id="L96">                        .findOne(Example.of(search, ExampleMatcher.matching().withIgnorePaths(&quot;hierarchical&quot;)))</span>
<span class="fc" id="L97">                        .orElse(null);</span>

<span class="pc bpc" id="L99" title="1 of 2 branches missed.">                if (roleEntity == null) {</span>
<span class="nc" id="L100">                    LOGGER.error(&quot;could not find role with name {}&quot;, role);</span>
                } else {
<span class="fc" id="L102">                    TenantRoleEntity tenantRoleEntity = new TenantRoleEntity();</span>
<span class="fc" id="L103">                    tenantRoleEntity.setUser(userEntity);</span>
<span class="fc" id="L104">                    tenantRoleEntity.setTenant(tenantRepository</span>
<span class="fc" id="L105">                            .findById(SYSTEM_TENANT_ID)</span>
<span class="pc" id="L106">                            .orElseThrow(() -&gt; new NexusRuntimeException(NexusError.builder()</span>
<span class="nc" id="L107">                                    .message(&quot;System tenant not found&quot;)</span>
<span class="nc" id="L108">                                    .build())));</span>
<span class="fc" id="L109">                    tenantRoleEntity.setRole(roleEntity);</span>

<span class="fc" id="L111">                    tenantRoleRepository.save(tenantRoleEntity);</span>
                }
<span class="fc" id="L113">            }</span>
        }
<span class="fc" id="L115">    }</span>

    @Override
    public void exportConfig(ConfigExportContext configExportContext) {
<span class="fc" id="L119">        userRepository.findAllByDeletedNull().stream()</span>
<span class="fc" id="L120">                .map(userConfigMapper::toConfig)</span>
<span class="fc" id="L121">                .forEach(</span>
<span class="fc" id="L122">                        userConfig -&gt; configExportContext.getConfig().getUsers().add(userConfig));</span>
<span class="fc" id="L123">    }</span>

    @Override
    public List&lt;UserConfig&gt; merge(Collection&lt;UserConfig&gt; oldConfigs, Collection&lt;UserConfig&gt; newConfigs) {
<span class="fc" id="L127">        List&lt;UserConfig&gt; mergedConfigs = new ArrayList&lt;&gt;(oldConfigs);</span>

<span class="fc bfc" id="L129" title="All 2 branches covered.">        for (UserConfig oldConfig : oldConfigs) {</span>
<span class="fc" id="L130">            newConfigs.stream()</span>
<span class="fc" id="L131">                    .filter(newConfig -&gt; isSameUser(newConfig, oldConfig))</span>
<span class="fc" id="L132">                    .findFirst()</span>
<span class="fc" id="L133">                    .ifPresent(newConfig -&gt; userConfigMapper.merge(newConfig, oldConfig));</span>
<span class="fc" id="L134">        }</span>

<span class="fc bfc" id="L136" title="All 2 branches covered.">        for (UserConfig newConfig : newConfigs) {</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">            if (mergedConfigs.stream().noneMatch(mergedConfig -&gt; isSameUser(mergedConfig, newConfig))) {</span>
<span class="fc" id="L138">                mergedConfigs.add(newConfig);</span>
            }
<span class="fc" id="L140">        }</span>

<span class="fc" id="L142">        return mergedConfigs;</span>
    }

    private boolean isSameUser(UserConfig config1, UserConfig config2) {
<span class="fc" id="L146">        List&lt;Function&lt;UserConfig, String&gt;&gt; checks = List.of(UserConfig::getUserName, UserConfig::getEmail);</span>

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        return ObjectUtils.allNotNull(config1, config2)</span>
<span class="fc" id="L149">                &amp;&amp; checks.stream()</span>
<span class="fc bfc" id="L150" title="All 4 branches covered.">                        .anyMatch(f -&gt; ObjectUtils.allNotNull(f.apply(config1), f.apply(config2))</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">                                &amp;&amp; StringUtils.equalsIgnoreCase(f.apply(config1), f.apply(config2)));</span>
    }

    @Override
    public void sort(NexusConfig nexusConfig) {
<span class="fc" id="L156">        nexusConfig</span>
<span class="fc" id="L157">                .getUsers()</span>
<span class="fc" id="L158">                .sort(ComparatorUtils.chainedComparator(Arrays.asList(</span>
                        new TransformingComparator&lt;&gt;(UserConfig::getUserName, new NullComparator&lt;&gt;()),
                        new TransformingComparator&lt;&gt;(UserConfig::getEmail, new NullComparator&lt;&gt;()))));
<span class="fc" id="L161">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>