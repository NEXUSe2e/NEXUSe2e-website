<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SftpClientWrapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.impl.service.inbound</a> &gt; <span class="el_source">SftpClientWrapper.java</span></div><h1>SftpClientWrapper.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.impl.service.inbound;

import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import java.io.IOException;
import java.io.InputStream;
import java.util.EnumSet;
import java.util.List;
import java.util.Set;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.apache.sshd.client.SshClient;
import org.apache.sshd.client.session.ClientSession;
import org.apache.sshd.common.NamedFactory;
import org.apache.sshd.common.signature.BuiltinSignatures;
import org.apache.sshd.common.signature.Signature;
import org.apache.sshd.sftp.client.SftpClient;
import org.apache.sshd.sftp.client.SftpClientFactory;
import org.apache.sshd.sftp.common.SftpConstants;
import org.apache.sshd.sftp.common.SftpException;

<span class="fc" id="L23">@Slf4j</span>
@RequiredArgsConstructor
public class SftpClientWrapper implements AutoCloseable {

    private SshClient sshClient;
    private SftpClient sftpClient;
    private final SftpClientConfig clientConfig;
    private ClientSession clientSession;

    public void persistFile(InputStream inputStream, String path) throws NexusException {

<span class="fc" id="L34">        connect();</span>

<span class="fc" id="L36">        String targetPath = concatServerRoot(path);</span>
        try {
<span class="fc" id="L38">            sftpClient.put(inputStream, targetPath);</span>
<span class="fc" id="L39">        } catch (IOException e) {</span>
<span class="fc" id="L40">            throw new NexusException(</span>
<span class="fc" id="L41">                    NexusError.builder()</span>
<span class="fc" id="L42">                            .message(&quot;failed to upload file to SFTP server at path: &quot; + targetPath)</span>
<span class="fc" id="L43">                            .build(),</span>
                    e);
<span class="fc" id="L45">        }</span>
<span class="fc" id="L46">    }</span>

    public boolean rootNotExists() throws NexusException {
<span class="fc bfc" id="L49" title="All 2 branches covered.">        return !rootExists();</span>
    }

    public boolean rootExists() throws NexusException {
<span class="fc" id="L53">        connect();</span>
<span class="fc" id="L54">        return exists(&quot;&quot;);</span>
    }

    public boolean exists(String path) throws NexusException {
<span class="fc" id="L58">        connect();</span>
<span class="fc" id="L59">        String resultingPath = path;</span>
        try {
<span class="fc" id="L61">            resultingPath = SftpUtils.cleanupAndValidateRelativePath(path);</span>
<span class="fc" id="L62">            resultingPath = concatServerRoot(resultingPath);</span>
<span class="fc" id="L63">            sftpClient.stat(resultingPath);</span>
<span class="fc" id="L64">            return true;</span>
<span class="fc" id="L65">        } catch (SftpException sftpException) {</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">            if (sftpException.getStatus() == SftpConstants.SSH_FX_NO_SUCH_FILE) {</span>
<span class="fc" id="L67">                return false;</span>
            }
<span class="nc" id="L69">            throw new NexusException(</span>
<span class="nc" id="L70">                    NexusError.builder()</span>
<span class="nc" id="L71">                            .message(&quot;sftp error while accessing server path: &quot; + resultingPath)</span>
<span class="nc" id="L72">                            .build(),</span>
                    sftpException);
<span class="nc" id="L74">        } catch (IOException e) {</span>

<span class="nc" id="L76">            throw new NexusException(</span>
<span class="nc" id="L77">                    NexusError.builder()</span>
<span class="nc" id="L78">                            .message(&quot;error while accessing server path: &quot; + resultingPath)</span>
<span class="nc" id="L79">                            .build(),</span>
                    e);
        }
    }

    public boolean notExists(String path) throws NexusException {
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">        return !exists(path);</span>
    }

    public void mkDirs(String path) throws NexusException {
<span class="fc" id="L89">        connect();</span>

<span class="fc" id="L91">        String[] array = path.split(&quot;/&quot;);</span>
<span class="fc" id="L92">        String serverRoot = clientConfig.getServerRoot();</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (serverRoot.startsWith(&quot;/&quot;)) {</span>
<span class="fc" id="L94">            serverRoot = serverRoot.substring(1);</span>
        }
<span class="fc" id="L96">        StringBuilder targetPath = new StringBuilder(serverRoot);</span>

<span class="fc bfc" id="L98" title="All 2 branches covered.">        for (String dir : array) {</span>
<span class="fc" id="L99">            targetPath.append(dir);</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">            if (notExists(targetPath.toString())) {</span>
                try {
<span class="fc" id="L102">                    LOGGER.trace(&quot;creating directory at path: {}&quot;, targetPath);</span>
<span class="fc" id="L103">                    sftpClient.mkdir(targetPath.toString());</span>
<span class="nc" id="L104">                } catch (IOException e) {</span>
<span class="nc" id="L105">                    throw new NexusException(</span>
<span class="nc" id="L106">                            NexusError.builder()</span>
<span class="nc" id="L107">                                    .message(&quot;unable to create directories at path: &quot; + targetPath)</span>
<span class="nc" id="L108">                                    .build(),</span>
                            e);
<span class="fc" id="L110">                }</span>
            }
            // while windows ignores the trailing slash, linux does not. Therefore, the append is moved at the end of
            // the loop
<span class="fc" id="L114">            targetPath.append('/');</span>
        }
<span class="fc" id="L116">    }</span>

    @SuppressWarnings(&quot;deprecation&quot;)
    private void connect() throws NexusException {

        // If the client is already started, we do not need to reinitialize it
<span class="pc bpc" id="L122" title="1 of 4 branches missed.">        if (sshClient != null &amp;&amp; sshClient.isStarted()) {</span>
<span class="fc" id="L123">            return;</span>
        }

<span class="fc" id="L126">        sshClient = SshClient.setUpDefaultClient();</span>
        // TODO: replace with with multiselect and options from enum list as soon as its available
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (clientConfig.isEnableDeprecatedAlgorithms()) {</span>
<span class="nc" id="L129">            List&lt;NamedFactory&lt;Signature&gt;&gt; signatureFactories = sshClient.getSignatureFactories();</span>
<span class="nc" id="L130">            Set&lt;BuiltinSignatures&gt; signatures = EnumSet.of(BuiltinSignatures.dsa);</span>
<span class="nc" id="L131">            signatureFactories.addAll(NamedFactory.setUpBuiltinFactories(false, signatures));</span>
<span class="nc" id="L132">            sshClient.setSignatureFactories(signatureFactories);</span>
        }
<span class="fc" id="L134">        sshClient.start();</span>
        try {
<span class="fc" id="L136">            clientSession = sshClient</span>
<span class="fc" id="L137">                    .connect(clientConfig.getUser(), clientConfig.getHost(), clientConfig.getPort())</span>
<span class="fc" id="L138">                    .verify(clientConfig.getServerConnectTimeout())</span>
<span class="fc" id="L139">                    .getSession();</span>
<span class="nc" id="L140">        } catch (Exception e) {</span>
<span class="nc" id="L141">            throw new NexusException(</span>
<span class="nc" id="L142">                    NexusError.builder()</span>
<span class="nc" id="L143">                            .message(&quot;unable to create ssh client session&quot;)</span>
<span class="nc" id="L144">                            .build(),</span>
                    e);
<span class="fc" id="L146">        }</span>

<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (StringUtils.isNotBlank(clientConfig.getPrivateKeyData())) {</span>
<span class="fc" id="L149">            SftpUtils.authenticateSessionViaSshKey(</span>
<span class="fc" id="L150">                    clientSession, clientConfig.getPrivateKeyData(), clientConfig.getPrivateKeyPassword());</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        } else if (StringUtils.isNotBlank(clientConfig.getPassword())) {</span>
<span class="fc" id="L152">            SftpUtils.authenticateSessionViaPassword(clientSession, clientConfig.getPassword());</span>
        } else {
<span class="nc" id="L154">            throw new NexusException(NexusError.builder()</span>
<span class="nc" id="L155">                    .message(&quot;SSH Key or password must be provided for authentication&quot;)</span>
<span class="nc" id="L156">                    .build());</span>
        }
        try {
<span class="fc" id="L159">            clientSession.auth().verify(clientConfig.getServerConnectTimeout());</span>

<span class="fc" id="L161">            sftpClient = SftpClientFactory.instance().createSftpClient(clientSession);</span>
<span class="nc" id="L162">        } catch (IOException e) {</span>
<span class="nc" id="L163">            throw new NexusException(</span>
<span class="nc" id="L164">                    NexusError.builder()</span>
<span class="nc" id="L165">                            .message(&quot;unable to configure and create SFTP client session&quot;)</span>
<span class="nc" id="L166">                            .build(),</span>
                    e);
<span class="fc" id="L168">        }</span>

        try {
<span class="fc" id="L171">            SftpUtils.applyHostKeyValidation(</span>
<span class="fc" id="L172">                    sshClient, clientConfig.getHostKeyAlgorithm(), clientConfig.getHostKeyData());</span>
<span class="nc" id="L173">        } catch (Exception e) {</span>
<span class="nc" id="L174">            throw new NexusException(</span>
<span class="nc" id="L175">                    NexusError.builder()</span>
<span class="nc" id="L176">                            .message(&quot;unable to apply host key validation&quot;)</span>
<span class="nc" id="L177">                            .build(),</span>
                    e);
<span class="fc" id="L179">        }</span>
<span class="fc" id="L180">    }</span>

    private String concatServerRoot(String path) {
<span class="fc" id="L183">        String targetPath = clientConfig.getServerRoot();</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">        if (StringUtils.isNotBlank(path)) {</span>
<span class="fc" id="L185">            targetPath = targetPath + path;</span>
        }
<span class="fc" id="L187">        return targetPath;</span>
    }

    @Override
    public void close() throws Exception {
        try {
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">            if (sftpClient != null) {</span>
<span class="fc" id="L194">                sftpClient.close();</span>
            }
<span class="nc" id="L196">        } catch (IOException e) {</span>
<span class="nc" id="L197">            LOGGER.error(&quot;Error closing SFTP client&quot;, e);</span>
<span class="fc" id="L198">        }</span>
        try {
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            if (clientSession != null) {</span>
<span class="fc" id="L201">                clientSession.close();</span>
            }
<span class="nc" id="L203">        } catch (IOException e) {</span>
<span class="nc" id="L204">            LOGGER.error(&quot;Error closing client session&quot;, e);</span>
<span class="fc" id="L205">        }</span>
        try {
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">            if (sshClient != null) {</span>
<span class="fc" id="L208">                sshClient.close();</span>
            }
<span class="nc" id="L210">        } catch (IOException e) {</span>
<span class="nc" id="L211">            LOGGER.error(&quot;Error closing ssh client&quot;, e);</span>
<span class="fc" id="L212">        }</span>
<span class="fc" id="L213">        sshClient = null;</span>
<span class="fc" id="L214">        sftpClient = null;</span>
<span class="fc" id="L215">        clientSession = null;</span>
<span class="fc" id="L216">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>