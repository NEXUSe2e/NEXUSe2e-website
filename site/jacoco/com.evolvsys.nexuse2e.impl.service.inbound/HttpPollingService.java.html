<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpPollingService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.impl.service.inbound</a> &gt; <span class="el_source">HttpPollingService.java</span></div><h1>HttpPollingService.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.impl.service.inbound;

import com.evolvsys.nexuse2e.core.component.BeanFactoryAware;
import com.evolvsys.nexuse2e.core.constants.HttpConstants;
import com.evolvsys.nexuse2e.core.constants.TransactionConstants;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.message.MessageStatus;
import com.evolvsys.nexuse2e.core.message.MetaData;
import com.evolvsys.nexuse2e.core.message.context.MessageContext;
import com.evolvsys.nexuse2e.core.message.payload.content.PayloadContent;
import com.evolvsys.nexuse2e.core.parameter.ParameterDefinition;
import com.evolvsys.nexuse2e.core.parameter.ParameterType;
import com.evolvsys.nexuse2e.core.parameter.model.ActionInfo;
import com.evolvsys.nexuse2e.core.schedule.SchedulingService;
import com.evolvsys.nexuse2e.core.schedule.SchedulingServiceAware;
import com.evolvsys.nexuse2e.core.service.StandardNexusInflowService;
import com.evolvsys.nexuse2e.core.service.http.WebClientContext;
import com.evolvsys.nexuse2e.core.service.http.client.reactive.NexusWebClientFactory;
import com.evolvsys.nexuse2e.impl.parameter.HttpConnectionParameters;
import com.evolvsys.nexuse2e.impl.service.support.HttpAuthenticationSupportService;
import com.evolvsys.nexuse2e.impl.service.support.transformator.TransformatorSupportService;
import com.evolvsys.nexuse2e.impl.util.SchedulingUtils;
import com.evolvsys.nexuse2e.internal.ContextPayload;
import com.evolvsys.nexuse2e.internal.Message;
import com.evolvsys.nexuse2e.internal.MessageType;
import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.Charset;
import java.nio.charset.StandardCharsets;
import java.time.ZonedDateTime;
import java.util.*;
import lombok.Setter;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.collections4.KeyValue;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.BeanFactory;
import org.springframework.core.io.buffer.DataBuffer;
import org.springframework.http.*;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.util.unit.DataSize;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;

/**
 * @author Florian Drees
 * @since 07.06.2024
 */
<span class="fc" id="L51">@Slf4j</span>
@Setter
<span class="fc" id="L53">public class HttpPollingService extends StandardNexusInflowService</span>
        implements SchedulingServiceAware, BeanFactoryAware, HttpConnectionParameters {
    private static final String PARAM_HEADERS = &quot;additional_headers&quot;;
    private static final String PARAM_QUERY_PARAMETERS = &quot;query_parameters&quot;;
    private static final String PARAM_SSL = &quot;use_ssl&quot;;
    private static final String PARAM_MAX_IN_MEMORY_SIZE = &quot;max_in_memory_size&quot;;
    private static final String PARAM_CHOREOGRAPHY_ACTION = &quot;choreography_action&quot;;
    private static final String PARAM_TARGET_PARTNER_ID = &quot;target_partner_id&quot;;
    private static final String PARAM_TRANSFORMATOR_SERVICE = &quot;transformator_service&quot;;
    private static final String PARAM_INCREMENTAL_CONVERSATION_ID = &quot;incremental_conversation_id&quot;;
    private static final String PARAM_ADD_TRANSACTION_DATA = &quot;add_transaction_data&quot;;

    private static final long DEFAULT_MAX_IN_MEMORY_SIZE = -1;
    private static final String URL_STRING = &quot;url&quot;;
    private static final String SERVICE_ID = &quot;serviceId&quot;;

    private SchedulingService schedulingService;
    private BeanFactory beanFactory;

    @Override
    public List&lt;ParameterDefinition&gt; parameterDefinitions() {
<span class="fc" id="L74">        return List.of(</span>
<span class="fc" id="L75">                URL.get().description(&quot;Url where the data should be read from&quot;).build(),</span>
<span class="fc" id="L76">                METHOD.get()</span>
<span class="fc" id="L77">                        .clearOptions()</span>
<span class="fc" id="L78">                        .option(HttpMethod.GET.name())</span>
<span class="fc" id="L79">                        .option(HttpMethod.POST.name())</span>
<span class="fc" id="L80">                        .defaultValue(HttpMethod.GET.toString())</span>
<span class="fc" id="L81">                        .build(),</span>
<span class="fc" id="L82">                CONNECTION_TIMEOUT.get().build(),</span>
<span class="fc" id="L83">                RESPONSE_TIMEOUT.get().build(),</span>
<span class="fc" id="L84">                SSL_PROTOCOLS.get().build(),</span>
<span class="fc" id="L85">                SSL_CIPHERS.get().build(),</span>
<span class="fc" id="L86">                ENABLE_HOSTNAME_VERIFICATION.get().build(),</span>
<span class="fc" id="L87">                VALIDATE_CERT_CHAIN.get().build(),</span>
<span class="fc" id="L88">                ParameterDefinition.builder()</span>
<span class="fc" id="L89">                        .name(PARAM_HEADERS)</span>
<span class="fc" id="L90">                        .displayName(&quot;Additional headers&quot;)</span>
<span class="fc" id="L91">                        .description(&quot;Additional http headers to be sent with the request&quot;)</span>
<span class="fc" id="L92">                        .type(ParameterType.KEY_VALUE_PAIR_LIST_TRIMMED)</span>
<span class="fc" id="L93">                        .build(),</span>
<span class="fc" id="L94">                ParameterDefinition.builder()</span>
<span class="fc" id="L95">                        .name(PARAM_QUERY_PARAMETERS)</span>
<span class="fc" id="L96">                        .displayName(&quot;Query parameters&quot;)</span>
<span class="fc" id="L97">                        .description(&quot;Additional query parameters to be sent with the request&quot;)</span>
<span class="fc" id="L98">                        .type(ParameterType.KEY_VALUE_PAIR_LIST_TRIMMED)</span>
<span class="fc" id="L99">                        .build(),</span>
<span class="fc" id="L100">                ParameterDefinition.builder()</span>
<span class="fc" id="L101">                        .name(PARAM_SSL)</span>
<span class="fc" id="L102">                        .displayName(&quot;Use SSL&quot;)</span>
<span class="fc" id="L103">                        .description(&quot;Enables SSL for this request&quot;)</span>
<span class="fc" id="L104">                        .type(ParameterType.BOOLEAN)</span>
<span class="fc" id="L105">                        .defaultValue(Boolean.TRUE)</span>
<span class="fc" id="L106">                        .build(),</span>
<span class="fc" id="L107">                AUTH_SERVICE.get().build(),</span>
<span class="fc" id="L108">                ParameterDefinition.builder()</span>
<span class="fc" id="L109">                        .name(PARAM_MAX_IN_MEMORY_SIZE)</span>
<span class="fc" id="L110">                        .displayName(&quot;Maximum memory size (in kilobytes)&quot;)</span>
<span class="fc" id="L111">                        .description(</span>
                                &quot;Limit of number of kilobytes (of the response) to buffer. If set to -1 no limit is applied.&quot;)
<span class="fc" id="L113">                        .type(ParameterType.LONG)</span>
<span class="fc" id="L114">                        .defaultValue(DEFAULT_MAX_IN_MEMORY_SIZE)</span>
<span class="fc" id="L115">                        .build(),</span>
<span class="fc" id="L116">                ParameterDefinition.builder()</span>
<span class="fc" id="L117">                        .name(PARAM_TARGET_PARTNER_ID)</span>
<span class="fc" id="L118">                        .displayName(&quot;Target Partner Id&quot;)</span>
<span class="fc" id="L119">                        .description(&quot;Optional static target partner id for all messages created by this service.&quot;)</span>
<span class="fc" id="L120">                        .type(ParameterType.STRING)</span>
<span class="fc" id="L121">                        .build(),</span>
<span class="fc" id="L122">                ParameterDefinition.builder()</span>
<span class="fc" id="L123">                        .name(PARAM_CHOREOGRAPHY_ACTION)</span>
<span class="fc" id="L124">                        .displayName(&quot;Choreography &amp; Action&quot;)</span>
<span class="fc" id="L125">                        .description(&quot;Optional static action id used for all messages.&quot;)</span>
<span class="fc" id="L126">                        .type(ParameterType.ACTION_NAME)</span>
<span class="fc" id="L127">                        .build(),</span>
<span class="fc" id="L128">                createCronPatternScheduleParameter(),</span>
<span class="fc" id="L129">                createHourMinuteScheduleParameter(),</span>
<span class="fc" id="L130">                createDurationScheduleParameter(),</span>
<span class="fc" id="L131">                createMisfireScheduleParameter(),</span>
<span class="fc" id="L132">                ParameterDefinition.builder()</span>
<span class="fc" id="L133">                        .name(PARAM_TRANSFORMATOR_SERVICE)</span>
<span class="fc" id="L134">                        .displayName(&quot;Transformator service&quot;)</span>
<span class="fc" id="L135">                        .description(&quot;Optional service to transform the payloads before building message contexts.&quot;)</span>
<span class="fc" id="L136">                        .type(ParameterType.SUPPORT_SERVICE)</span>
<span class="fc" id="L137">                        .build(),</span>
<span class="fc" id="L138">                ParameterDefinition.builder()</span>
<span class="fc" id="L139">                        .name(PARAM_INCREMENTAL_CONVERSATION_ID)</span>
<span class="fc" id="L140">                        .displayName(&quot;Incremental conversation id&quot;)</span>
<span class="fc" id="L141">                        .description(</span>
                                &quot;If multiple conversations are generated, a single random id will be generated and each conversation will have an incremental suffix.&quot;)
<span class="fc" id="L143">                        .type(ParameterType.BOOLEAN)</span>
<span class="fc" id="L144">                        .required(true)</span>
<span class="fc" id="L145">                        .defaultValue(Boolean.FALSE)</span>
<span class="fc" id="L146">                        .build(),</span>
<span class="fc" id="L147">                ParameterDefinition.builder()</span>
<span class="fc" id="L148">                        .name(PARAM_ADD_TRANSACTION_DATA)</span>
<span class="fc" id="L149">                        .displayName(&quot;Add transaction data&quot;)</span>
<span class="fc" id="L150">                        .description(</span>
                                &quot;Add transactional meta data to each generated message. This meta data contains a unique id and timestamp, that are equal for all messages.&quot;)
<span class="fc" id="L152">                        .type(ParameterType.BOOLEAN)</span>
<span class="fc" id="L153">                        .required(true)</span>
<span class="fc" id="L154">                        .defaultValue(Boolean.FALSE)</span>
<span class="fc" id="L155">                        .build());</span>
    }

    @Override
    @SuppressWarnings(&quot;PMD.NcssCount&quot;)
    protected List&lt;MessageContext&gt; buildMessageContexts() throws NexusException {
<span class="fc" id="L161">        NexusWebClientFactory webClientFactory = beanFactory.getBean(NexusWebClientFactory.class);</span>

<span class="fc" id="L163">        WebClientContext.WebClientContextBuilder contextBuilder = webClientFactory</span>
<span class="fc" id="L164">                .createContextBuilder()</span>
<span class="fc" id="L165">                .connectionTimeout(parameters.value(PARAM_CONNECTION_TIMEOUT))</span>
<span class="fc" id="L166">                .responseTimeout(parameters.value(PARAM_RESPONSE_TIMEOUT))</span>
<span class="fc" id="L167">                .protocols(parameters.value(PARAM_SSL_PROTOCOLS))</span>
<span class="fc" id="L168">                .ciphers(parameters.value(PARAM_SSL_CIPHERS))</span>
<span class="fc" id="L169">                .disableHostNameVerification(Boolean.FALSE.equals(parameters.value(PARAM_ENABLE_HOSTNAME_VERIFICATION)))</span>
<span class="fc" id="L170">                .validateCertChain(parameters.value(PARAM_VALIDATE_CERT_CHAIN))</span>
<span class="fc" id="L171">                .ssl(Boolean.TRUE.equals(parameters.value(PARAM_SSL)));</span>

<span class="fc" id="L173">        WebClient.Builder webClientBuilder = webClientFactory.createWebClient(contextBuilder.build());</span>

<span class="fc" id="L175">        HttpAuthenticationSupportService authenticationSupportService = parameters.value(PARAM_AUTH_SERVICE);</span>
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (authenticationSupportService != null) {</span>
<span class="nc" id="L177">            LOGGER.debug(&quot;using authentication support service {}&quot;, authenticationSupportService.getServiceId());</span>
<span class="nc" id="L178">            authenticationSupportService.addAuthentication(webClientBuilder);</span>
        }

<span class="fc" id="L181">        int maxInMemorySize =</span>
<span class="fc" id="L182">                parameters.value(PARAM_MAX_IN_MEMORY_SIZE, Long.class).intValue();</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (maxInMemorySize &gt; -1) {</span>
<span class="nc" id="L184">            maxInMemorySize = (int) DataSize.ofKilobytes(maxInMemorySize).toBytes();</span>
        }
<span class="fc" id="L186">        final int finalMaxInMemorySize = maxInMemorySize;</span>

<span class="fc" id="L188">        String baseUrl = parameters.value(PARAM_URL);</span>

<span class="fc" id="L190">        MultiValueMap&lt;String, String&gt; queryParameters = toMultiValueMap(parameters.value(PARAM_QUERY_PARAMETERS));</span>

<span class="fc" id="L192">        WebClient.RequestHeadersSpec&lt;?&gt; requestHeadersSpec = webClientBuilder</span>
<span class="fc" id="L193">                .baseUrl(baseUrl)</span>
<span class="fc" id="L194">                .codecs(configurer -&gt; configurer.defaultCodecs().maxInMemorySize(finalMaxInMemorySize))</span>
<span class="fc" id="L195">                .build()</span>
<span class="fc" id="L196">                .method(HttpMethod.valueOf(parameters.value(PARAM_METHOD)))</span>
<span class="fc" id="L197">                .uri(uriBuilder -&gt; uriBuilder.queryParams(queryParameters).build())</span>
<span class="fc" id="L198">                .headers(this::addHttpHeaders);</span>

<span class="fc" id="L200">        List&lt;MessageContext&gt; messageContexts = new ArrayList&lt;&gt;();</span>
        ResponseEntity&lt;DataBuffer&gt; response;
        try {
<span class="fc" id="L203">            response = requestHeadersSpec.retrieve().toEntity(DataBuffer.class).block();</span>
<span class="nc" id="L204">        } catch (Exception e) {</span>
<span class="nc bnc" id="L205" title="All 4 branches missed.">            if (e instanceof WebClientResponseException we &amp;&amp; StringUtils.isNotEmpty(we.getResponseBodyAsString())) {</span>
<span class="nc" id="L206">                throw new NexusException(</span>
<span class="nc" id="L207">                        NexusError.builder()</span>
<span class="nc" id="L208">                                .message(String.format(</span>
                                        &quot;Error polling from http target - error response: '%s'&quot;,
<span class="nc" id="L210">                                        we.getResponseBodyAsString()))</span>
<span class="nc" id="L211">                                .extension(&quot;statusCode&quot;, we.getStatusCode().value())</span>
<span class="nc" id="L212">                                .extension(&quot;statusText&quot;, we.getStatusText())</span>
<span class="nc" id="L213">                                .extension(SERVICE_ID, getServiceId())</span>
<span class="nc" id="L214">                                .extension(URL_STRING, baseUrl)</span>
<span class="nc" id="L215">                                .build(),</span>
                        e);
            }
<span class="nc" id="L218">            throw new NexusException(</span>
<span class="nc" id="L219">                    NexusError.builder()</span>
<span class="nc" id="L220">                            .message(String.format(&quot;Error polling from http target: '%s'&quot;, e.getMessage()))</span>
<span class="nc" id="L221">                            .extension(SERVICE_ID, getServiceId())</span>
<span class="nc" id="L222">                            .extension(URL_STRING, baseUrl)</span>
<span class="nc" id="L223">                            .build(),</span>
                    e);
<span class="fc" id="L225">        }</span>

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (response == null) {</span>
<span class="nc" id="L228">            LOGGER.debug(&quot;Got no response&quot;);</span>
<span class="nc" id="L229">            throw new NexusException(NexusError.builder()</span>
<span class="nc" id="L230">                    .message(&quot;Got no response from http target&quot;)</span>
<span class="nc" id="L231">                    .extension(SERVICE_ID, getServiceId())</span>
<span class="nc" id="L232">                    .extension(URL_STRING, baseUrl)</span>
<span class="nc" id="L233">                    .build());</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">        } else if (isValidResponseStatus(response.getStatusCode())) {</span>
<span class="fc" id="L235">            LOGGER.debug(&quot;Got response with status code '{}'&quot;, response.getStatusCode());</span>

<span class="fc" id="L237">            MetaData metaData = new MetaData();</span>

<span class="fc bfc" id="L239" title="All 2 branches covered.">            for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : queryParameters.entrySet()) {</span>
<span class="fc" id="L240">                entry.getValue()</span>
<span class="fc" id="L241">                        .forEach(entryValue -&gt;</span>
<span class="fc" id="L242">                                metaData.add(HttpConstants.PREFIX_QUERY_PARAMETERS, entry.getKey(), entryValue));</span>
<span class="fc" id="L243">            }</span>

<span class="fc" id="L245">            HttpHeaders responseHeaders = response.getHeaders();</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">            for (Map.Entry&lt;String, List&lt;String&gt;&gt; entry : responseHeaders.entrySet()) {</span>
<span class="fc" id="L247">                entry.getValue()</span>
<span class="fc" id="L248">                        .forEach(entryValue -&gt;</span>
<span class="fc" id="L249">                                metaData.add(HttpConstants.PREFIX_REQUEST_HEADER, entry.getKey(), entryValue));</span>
<span class="fc" id="L250">            }</span>

<span class="fc" id="L252">            MediaType contentType = responseHeaders.getContentType();</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">            if (contentType == null) {</span>
<span class="nc" id="L254">                throw new NexusException(NexusError.builder()</span>
<span class="nc" id="L255">                        .message(&quot;Content-Type is missing in response&quot;)</span>
<span class="nc" id="L256">                        .extension(SERVICE_ID, getServiceId())</span>
<span class="nc" id="L257">                        .extension(URL_STRING, baseUrl)</span>
<span class="nc" id="L258">                        .build());</span>
            }

<span class="fc" id="L261">            Charset encoding = Optional.ofNullable(contentType.getCharset()).orElse(StandardCharsets.UTF_8);</span>

<span class="fc" id="L263">            DataBuffer responseBody = response.getBody();</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">            if (responseBody != null) {</span>
<span class="fc" id="L265">                try (InputStream inputStream = responseBody.asInputStream()) {</span>
<span class="fc" id="L266">                    PayloadContent content = PayloadContent.of(inputStream, responseHeaders.getContentLength());</span>

<span class="fc" id="L268">                    ContextPayload contextPayload = ContextPayload.builder()</span>
<span class="fc" id="L269">                            .content(content)</span>
<span class="fc" id="L270">                            .encoding(encoding.name())</span>
<span class="fc" id="L271">                            .size(content.getSize())</span>
<span class="fc" id="L272">                            .contentType(String.join(&quot;/&quot;, contentType.getType(), contentType.getSubtype()))</span>
<span class="fc" id="L273">                            .build();</span>

<span class="fc" id="L275">                    boolean addTransactionData = parameters.value(PARAM_ADD_TRANSACTION_DATA);</span>
<span class="fc" id="L276">                    boolean incrementalConversationId = parameters.value(PARAM_INCREMENTAL_CONVERSATION_ID);</span>

<span class="fc" id="L278">                    String transactionId = null;</span>
<span class="fc" id="L279">                    ZonedDateTime transactionTime = null;</span>
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">                    if (parameters.value(PARAM_ADD_TRANSACTION_DATA)) {</span>
<span class="fc" id="L281">                        transactionId = UUID.randomUUID().toString();</span>
<span class="fc" id="L282">                        transactionTime = ZonedDateTime.now();</span>
                    }
<span class="fc" id="L284">                    String baseConversationId = null;</span>

<span class="fc" id="L286">                    TransformatorSupportService transformatorSupportService =</span>
<span class="fc" id="L287">                            parameters.value(PARAM_TRANSFORMATOR_SERVICE);</span>

<span class="pc bpc" id="L289" title="1 of 2 branches missed.">                    if (transformatorSupportService == null) {</span>
<span class="nc" id="L290">                        messageContexts.add(buildMessageContext(contextPayload, metaData));</span>
                    } else {
<span class="fc" id="L292">                        List&lt;ContextPayload&gt; transformedPayloads =</span>
<span class="fc" id="L293">                                transformatorSupportService.transform(List.of(contextPayload));</span>
<span class="fc" id="L294">                        handleTransformedPayloads(</span>
                                transformedPayloads,
                                metaData,
                                addTransactionData,
                                transactionTime,
                                transactionId,
                                incrementalConversationId,
                                baseConversationId,
                                messageContexts);
                    }
<span class="nc" id="L304">                } catch (IOException e) {</span>
<span class="nc" id="L305">                    throw new NexusException(</span>
<span class="nc" id="L306">                            NexusError.builder()</span>
<span class="nc" id="L307">                                    .message(&quot;Unable to get body of response as stream&quot;)</span>
<span class="nc" id="L308">                                    .extension(SERVICE_ID, getServiceId())</span>
<span class="nc" id="L309">                                    .extension(URL_STRING, baseUrl)</span>
<span class="nc" id="L310">                                    .build(),</span>
                            e);
<span class="fc" id="L312">                }</span>
            }
<span class="fc" id="L314">        } else {</span>
<span class="nc" id="L315">            DataBuffer responseBody = response.getBody();</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if (responseBody != null) {</span>
<span class="nc" id="L317">                LOGGER.error(&quot;Body response: {}&quot;, responseBody.toString(StandardCharsets.UTF_8));</span>
            }
<span class="nc" id="L319">            throw new NexusException(NexusError.builder()</span>
<span class="nc" id="L320">                    .message(&quot;Invalid response from http target&quot;)</span>
<span class="nc" id="L321">                    .extension(&quot;responseCode&quot;, response.getStatusCode().toString())</span>
<span class="nc" id="L322">                    .extension(SERVICE_ID, getServiceId())</span>
<span class="nc" id="L323">                    .extension(URL_STRING, baseUrl)</span>
<span class="nc" id="L324">                    .build());</span>
        }

<span class="fc" id="L327">        return messageContexts;</span>
    }

    private void handleTransformedPayloads(
            List&lt;ContextPayload&gt; transformedPayloads,
            MetaData metaData,
            boolean addTransactionData,
            ZonedDateTime transactionTime,
            String transactionId,
            boolean incrementalConversationId,
            String baseConversationId,
            Collection&lt;MessageContext&gt; messageContexts) {
<span class="fc bfc" id="L339" title="All 2 branches covered.">        for (int i = 0; i &lt; transformedPayloads.size(); i++) {</span>
<span class="fc" id="L340">            ContextPayload transformedPayload = transformedPayloads.get(i);</span>
<span class="fc" id="L341">            MessageContext messageContext = buildMessageContext(transformedPayload, metaData);</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">            if (addTransactionData) {</span>
<span class="fc" id="L343">                messageContext</span>
<span class="fc" id="L344">                        .getSourceMessage()</span>
<span class="fc" id="L345">                        .getMetaData()</span>
<span class="fc" id="L346">                        .add(</span>
                                TransactionConstants.CATEGORY,
                                TransactionConstants.TRANSACTION_TIMESTAMP,
                                transactionTime);
<span class="fc" id="L350">                messageContext</span>
<span class="fc" id="L351">                        .getSourceMessage()</span>
<span class="fc" id="L352">                        .getMetaData()</span>
<span class="fc" id="L353">                        .add(TransactionConstants.CATEGORY, TransactionConstants.TRANSACTION_ID, transactionId);</span>
            }
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">            if (incrementalConversationId) {</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">                if (baseConversationId == null) {</span>
<span class="fc" id="L357">                    baseConversationId =</span>
<span class="fc" id="L358">                            messageContext.getConversationIdGenerator().generateId();</span>
                }
<span class="fc bfc" id="L360" title="All 2 branches covered.">                if (transformedPayload</span>
<span class="fc" id="L361">                        .getMetaData()</span>
<span class="fc" id="L362">                        .getFirstOrDefault(TransformatorSupportService.META_DATA_RAW, Boolean.FALSE)) {</span>
<span class="fc" id="L363">                    messageContext.getSourceMessage().setConversationId(baseConversationId + &quot;-raw&quot;);</span>
<span class="fc" id="L364">                    messageContext</span>
<span class="fc" id="L365">                            .getSourceMessage()</span>
<span class="fc" id="L366">                            .getMetaData()</span>
<span class="fc" id="L367">                            .set(TransformatorSupportService.META_DATA_RAW, Boolean.TRUE);</span>
                } else {
<span class="fc" id="L369">                    messageContext.getSourceMessage().setConversationId(baseConversationId + &quot;-&quot; + i);</span>
                }
            }
<span class="fc" id="L372">            messageContexts.add(messageContext);</span>
        }
<span class="fc" id="L374">    }</span>

    protected MessageContext buildMessageContext(ContextPayload contextPayload, MetaData metaData) {
<span class="fc" id="L377">        MessageContext messageContext = getContextFactory().createNew();</span>

<span class="fc" id="L379">        Message sourceMessage = new Message();</span>
<span class="fc" id="L380">        sourceMessage.setType(MessageType.NORMAL);</span>
<span class="fc" id="L381">        sourceMessage.setMessageStatus(MessageStatus.CREATED);</span>
<span class="fc" id="L382">        messageContext.setSourceMessage(sourceMessage);</span>

<span class="fc" id="L384">        messageContext.setSourceData(contextPayload);</span>

<span class="fc" id="L386">        ActionInfo choreographyAndAction = parameters.value(PARAM_CHOREOGRAPHY_ACTION);</span>
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">        if (choreographyAndAction != null) {</span>
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">            if (StringUtils.isNotEmpty(choreographyAndAction.getChoreographyId())) {</span>
<span class="fc" id="L389">                messageContext.setChoreographyId(choreographyAndAction.getChoreographyId());</span>
            }
<span class="pc bpc" id="L391" title="1 of 2 branches missed.">            if (StringUtils.isNotEmpty(choreographyAndAction.getActionId())</span>
<span class="pc bpc" id="L392" title="1 of 2 branches missed.">                    &amp;&amp; StringUtils.isBlank(messageContext.getActionId())) {</span>
<span class="fc" id="L393">                messageContext.setActionId(choreographyAndAction.getActionId());</span>
            }
        }
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">        if (StringUtils.isNotEmpty(parameters.value(PARAM_TARGET_PARTNER_ID))) {</span>
<span class="fc" id="L397">            messageContext.setTargetPartnerId(parameters.value(PARAM_TARGET_PARTNER_ID));</span>
        }

<span class="fc" id="L400">        messageContext.getMetaData().set(metaData);</span>

<span class="fc" id="L402">        return messageContext;</span>
    }

    @Override
    public void start() {
<span class="nc" id="L407">        SchedulingUtils.start(this, schedulingService, parameters);</span>
<span class="nc" id="L408">    }</span>

    @Override
    public void stop() {
<span class="fc" id="L412">        schedulingService.deregister(this);</span>
<span class="fc" id="L413">    }</span>

    private void addHttpHeaders(HttpHeaders httpHeaders) {
<span class="fc" id="L416">        List&lt;KeyValue&lt;String, String&gt;&gt; keyValueList = parameters.value(PARAM_HEADERS);</span>
<span class="fc" id="L417">        CollectionUtils.emptyIfNull(keyValueList)</span>
<span class="pc" id="L418">                .forEach(keyValue -&gt; httpHeaders.add(keyValue.getKey(), keyValue.getValue()));</span>
<span class="fc" id="L419">    }</span>

    private MultiValueMap&lt;String, String&gt; toMultiValueMap(Collection&lt;KeyValue&lt;String, String&gt;&gt; keyValueList) {
<span class="fc" id="L422">        MultiValueMap&lt;String, String&gt; multiValueMap = new LinkedMultiValueMap&lt;&gt;();</span>
<span class="fc" id="L423">        CollectionUtils.emptyIfNull(keyValueList)</span>
<span class="fc" id="L424">                .forEach(keyValue -&gt; multiValueMap.add(keyValue.getKey(), keyValue.getValue()));</span>
<span class="fc" id="L425">        return multiValueMap;</span>
    }

    private boolean isValidResponseStatus(HttpStatusCode httpStatusCode) {
<span class="fc" id="L429">        return Set.of(HttpStatus.OK.value(), HttpStatus.NO_CONTENT.value()).contains(httpStatusCode.value());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>