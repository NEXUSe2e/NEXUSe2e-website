<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XPathToRoutingParamsPipelet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.impl.pipelet.common</a> &gt; <span class="el_source">XPathToRoutingParamsPipelet.java</span></div><h1>XPathToRoutingParamsPipelet.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.impl.pipelet.common;

import com.evolvsys.nexuse2e.core.component.Pipelet;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.message.context.ExecutionContext;
import com.evolvsys.nexuse2e.core.parameter.ParameterDefinition;
import com.evolvsys.nexuse2e.core.parameter.ParameterType;
import com.evolvsys.nexuse2e.impl.parameter.XPathParameters;
import com.evolvsys.nexuse2e.impl.util.XmlUtils;
import com.evolvsys.nexuse2e.internal.ContextPayload;
import com.evolvsys.nexuse2e.internal.Message;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.io.IOException;
import java.util.List;
import java.util.Optional;
import java.util.function.Consumer;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.w3c.dom.Document;
import org.xml.sax.SAXException;

/**
 *
 */
<span class="fc" id="L32">@Slf4j</span>
<span class="fc" id="L33">public class XPathToRoutingParamsPipelet extends Pipelet implements XPathParameters {</span>

    public static final String PARAM_CONVERSATION_ID_PATTERN = &quot;conversation_id_xpath&quot;;
    public static final String PARAM_MESSAGE_ID_PATTERN = &quot;message_id_xpath&quot;;
    public static final String PARAM_CHOREOGRAPHY_ID_PATTERN = &quot;choreography_id_xpath&quot;;
    public static final String PARAM_ACTION_ID_PATTERN = &quot;action_id_xpath&quot;;
    public static final String PARAM_SOURCE_PARTNER_ID_PATTERN = &quot;source_partner_id_xpath&quot;;
    public static final String PARAM_TARGET_PARTNER_ID_PATTERN = &quot;target_partner_id_xpath&quot;;

<span class="fc" id="L42">    private final XPath xpath = XPathFactory.newInstance().newXPath();</span>

    @Override
    public List&lt;ParameterDefinition&gt; parameterDefinitions() {
<span class="fc" id="L46">        return List.of(</span>
<span class="fc" id="L47">                ParameterDefinition.builder()</span>
<span class="fc" id="L48">                        .name(PARAM_CONVERSATION_ID_PATTERN)</span>
<span class="fc" id="L49">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="fc" id="L50">                        .displayName(&quot;Conversation Id XPath Pattern&quot;)</span>
<span class="fc" id="L51">                        .description(&quot;The pattern to generate the conversation id from the payload.&quot;)</span>
<span class="fc" id="L52">                        .build(),</span>
<span class="fc" id="L53">                ParameterDefinition.builder()</span>
<span class="fc" id="L54">                        .name(PARAM_MESSAGE_ID_PATTERN)</span>
<span class="fc" id="L55">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="fc" id="L56">                        .displayName(&quot;Message Id XPath Pattern&quot;)</span>
<span class="fc" id="L57">                        .description(&quot;The pattern to generate the message id from the payload.&quot;)</span>
<span class="fc" id="L58">                        .build(),</span>
<span class="fc" id="L59">                ParameterDefinition.builder()</span>
<span class="fc" id="L60">                        .name(PARAM_CHOREOGRAPHY_ID_PATTERN)</span>
<span class="fc" id="L61">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="fc" id="L62">                        .displayName(&quot;Choreography Id XPath Pattern&quot;)</span>
<span class="fc" id="L63">                        .description(&quot;The pattern to generate the choreography id from the payload.&quot;)</span>
<span class="fc" id="L64">                        .build(),</span>
<span class="fc" id="L65">                ParameterDefinition.builder()</span>
<span class="fc" id="L66">                        .name(PARAM_ACTION_ID_PATTERN)</span>
<span class="fc" id="L67">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="fc" id="L68">                        .displayName(&quot;Action XPath Pattern&quot;)</span>
<span class="fc" id="L69">                        .description(&quot;The pattern to generate the action id from the payload.&quot;)</span>
<span class="fc" id="L70">                        .build(),</span>
<span class="fc" id="L71">                ParameterDefinition.builder()</span>
<span class="fc" id="L72">                        .name(PARAM_SOURCE_PARTNER_ID_PATTERN)</span>
<span class="fc" id="L73">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="fc" id="L74">                        .displayName(&quot;Source Partner Id XPath Pattern&quot;)</span>
<span class="fc" id="L75">                        .description(&quot;The pattern to generate the source partner id from the payload.&quot;)</span>
<span class="fc" id="L76">                        .build(),</span>
<span class="fc" id="L77">                ParameterDefinition.builder()</span>
<span class="fc" id="L78">                        .name(PARAM_TARGET_PARTNER_ID_PATTERN)</span>
<span class="fc" id="L79">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="fc" id="L80">                        .displayName(&quot;Target Partner Id XPath Pattern&quot;)</span>
<span class="fc" id="L81">                        .description(&quot;The pattern to generate the target partner id from the payload.&quot;)</span>
<span class="fc" id="L82">                        .build(),</span>
<span class="fc" id="L83">                STOP_ON_FAIL.get().build(),</span>
<span class="fc" id="L84">                STOP_ON_NOT_FOUND.get().build(),</span>
<span class="fc" id="L85">                TRIM_RESULT.get().build());</span>
    }

    @Override
    public ExecutionContext execute(ExecutionContext executionContext) throws NexusException {

        try {
<span class="fc" id="L92">            Document xmlDocument = getDocument(executionContext);</span>

<span class="fc" id="L94">            String conversationPattern = getParameters().value(PARAM_CONVERSATION_ID_PATTERN);</span>
<span class="fc" id="L95">            String messagePattern = getParameters().value(PARAM_MESSAGE_ID_PATTERN);</span>
<span class="fc" id="L96">            String choreographyPattern = getParameters().value(PARAM_CHOREOGRAPHY_ID_PATTERN);</span>
<span class="fc" id="L97">            String actionPattern = getParameters().value(PARAM_ACTION_ID_PATTERN);</span>
<span class="fc" id="L98">            String sourcePartnerPattern = getParameters().value(PARAM_SOURCE_PARTNER_ID_PATTERN);</span>
<span class="fc" id="L99">            String targetPartnerPattern = getParameters().value(PARAM_TARGET_PARTNER_ID_PATTERN);</span>

<span class="fc" id="L101">            Message message = Optional.of(executionContext)</span>
<span class="fc" id="L102">                    .map(ExecutionContext::getMessage)</span>
<span class="pc" id="L103">                    .orElseThrow(() -&gt; new IOException(&quot;No message found in execution context.&quot;));</span>

<span class="fc" id="L105">            executeXpathAndSetId(conversationPattern, xmlDocument, message::setConversationId);</span>
<span class="fc" id="L106">            executeXpathAndSetId(messagePattern, xmlDocument, message::setId);</span>
<span class="fc" id="L107">            executeXpathAndSetId(choreographyPattern, xmlDocument, executionContext::setChoreographyId);</span>
<span class="fc" id="L108">            executeXpathAndSetId(actionPattern, xmlDocument, executionContext::setActionId);</span>
<span class="fc" id="L109">            executeXpathAndSetId(sourcePartnerPattern, xmlDocument, executionContext::setSourcePartnerId);</span>
<span class="fc" id="L110">            executeXpathAndSetId(targetPartnerPattern, xmlDocument, executionContext::setTargetPartnerId);</span>

<span class="fc" id="L112">        } catch (ParserConfigurationException | SAXException | IOException e) {</span>
<span class="fc" id="L113">            Boolean stopOnFail = getParameters().value(PARAM_STOP_ON_FAIL);</span>
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">            if (stopOnFail) {</span>
<span class="nc" id="L115">                throw new NexusException(</span>
<span class="nc" id="L116">                        NexusError.builder()</span>
<span class="nc" id="L117">                                .message(&quot;Error while executing xpath statement.&quot;)</span>
<span class="nc" id="L118">                                .build(),</span>
                        e);
            }
<span class="fc" id="L121">        }</span>
<span class="fc" id="L122">        return executionContext;</span>
    }

    @SuppressFBWarnings(&quot;XXE_DOCUMENT&quot;)
    private static Document getDocument(ExecutionContext executionContext)
            throws ParserConfigurationException, SAXException, IOException {
<span class="fc" id="L128">        ContextPayload payload = Optional.of(executionContext)</span>
<span class="fc" id="L129">                .map(ExecutionContext::getMessage)</span>
<span class="fc" id="L130">                .map(Message::getPayloads)</span>
<span class="fc" id="L131">                .filter(CollectionUtils::isNotEmpty)</span>
<span class="fc" id="L132">                .map(List::getFirst)</span>
<span class="fc" id="L133">                .orElseThrow(() -&gt; new IOException(&quot;No payload found in message.&quot;));</span>
<span class="fc" id="L134">        return XmlUtils.getDocument(payload);</span>
    }

    @SuppressFBWarnings({&quot;XPATH_INJECTION&quot;, &quot;SPP_PASSING_THIS_AS_PARM&quot;})
    private void executeXpathAndSetId(String pattern, Document xmlDocument, Consumer&lt;String&gt; setterMethod)
            throws NexusException {
<span class="fc bfc" id="L140" title="All 2 branches covered.">        if (StringUtils.isNotBlank(pattern)) {</span>
<span class="fc" id="L141">            String newId = null;</span>
            try {
<span class="fc" id="L143">                newId = (String) xpath.compile(pattern).evaluate(xmlDocument, XPathConstants.STRING);</span>
<span class="fc" id="L144">                LOGGER.trace(&quot;XPath pattern: {}, result: {}&quot;, pattern, newId);</span>
<span class="fc" id="L145">            } catch (XPathExpressionException e) {</span>
<span class="fc" id="L146">                Boolean stopOnFail = getParameters().value(PARAM_STOP_ON_FAIL);</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">                if (stopOnFail) {</span>
<span class="fc" id="L148">                    throw new NexusException(</span>
<span class="fc" id="L149">                            NexusError.builder()</span>
<span class="fc" id="L150">                                    .message(&quot;Error while executing xpath statement: &quot; + pattern)</span>
<span class="fc" id="L151">                                    .build(),</span>
                            e);
                }
<span class="fc" id="L154">            }</span>

<span class="fc bfc" id="L156" title="All 2 branches covered.">            if (StringUtils.isBlank(newId)) {</span>
<span class="fc" id="L157">                Boolean stopOnNotFound = getParameters().value(PARAM_STOP_ON_NOT_FOUND);</span>

<span class="fc bfc" id="L159" title="All 2 branches covered.">                if (stopOnNotFound) {</span>
<span class="fc" id="L160">                    throw new NexusException(NexusError.builder()</span>
<span class="fc" id="L161">                            .message(&quot;No Id value found for xpath statement: &quot; + pattern)</span>
<span class="fc" id="L162">                            .build());</span>
                }
<span class="fc" id="L164">            } else {</span>
<span class="fc" id="L165">                setterMethod.accept(trimResult(newId, this));</span>
            }
        }
<span class="fc" id="L168">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>