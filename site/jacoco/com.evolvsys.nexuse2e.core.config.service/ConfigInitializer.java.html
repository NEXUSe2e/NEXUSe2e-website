<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfigInitializer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.config.service</a> &gt; <span class="el_source">ConfigInitializer.java</span></div><h1>ConfigInitializer.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.config.service;

import com.evolvsys.nexuse2e.core.config.ConfigValidatorService;
import com.evolvsys.nexuse2e.core.config.NEXUSe2eConfigurationProperties;
import com.evolvsys.nexuse2e.core.config.model.ConfigValidationResult;
import com.evolvsys.nexuse2e.core.config.model.NexusConfig;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.exception.NexusRuntimeException;
import com.evolvsys.nexuse2e.core.lifecycle.LifecycleConstants;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.SmartLifecycle;
import org.springframework.stereotype.Component;

/**
 * @author SvenBarden
 * @since 21.11.2024
 */
@Component
@RequiredArgsConstructor
<span class="fc" id="L24">@Slf4j</span>
class ConfigInitializer implements SmartLifecycle {
    private final NEXUSe2eConfigurationProperties configurationProperties;
    private final ConfigCrudService configCrudService;
    private final ConfigValidatorService configValidatorService;
    private boolean running;

    private void applyDefault() throws NexusException {
<span class="fc bfc" id="L32" title="All 2 branches covered.">        if (configCrudService.count() &lt;= 0) {</span>
<span class="fc" id="L33">            LOGGER.info(&quot;parsing default config&quot;);</span>

            NexusConfig nexusConfig;
            try {
<span class="fc" id="L37">                nexusConfig = configCrudService.get(</span>
<span class="fc" id="L38">                        configurationProperties.getDefaultConfig().getContentAsString(StandardCharsets.UTF_8));</span>
<span class="fc" id="L39">            } catch (IOException e) {</span>
<span class="fc" id="L40">                throw new NexusException(</span>
<span class="fc" id="L41">                        NexusError.builder()</span>
<span class="fc" id="L42">                                .message(&quot;Could not load default configuration&quot;)</span>
<span class="fc" id="L43">                                .build(),</span>
                        e);
<span class="fc" id="L45">            }</span>

<span class="fc" id="L47">            ConfigValidationResult validationResult = configValidatorService.validate(nexusConfig);</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">            if (validationResult.getFatalCount() &gt; 0) {</span>
<span class="fc" id="L49">                LOGGER.error(</span>
                        &quot;Could not apply default config due to {} fatal errors. Please fix those errors and restart&quot;
                                + &quot; the service.&quot;,
<span class="fc" id="L52">                        validationResult.getFatalCount());</span>
<span class="fc" id="L53">                throw new NexusException(NexusError.builder()</span>
<span class="fc" id="L54">                        .message(&quot;Fatal errors occurred while applying default config&quot;)</span>
<span class="fc" id="L55">                        .extension(&quot;fatalErrorCount&quot;, validationResult.getFatalCount())</span>
<span class="fc" id="L56">                        .extension(&quot;errorCount&quot;, validationResult.getErrorCount())</span>
<span class="fc" id="L57">                        .extension(&quot;warningCount&quot;, validationResult.getWarningCount())</span>
<span class="fc" id="L58">                        .build());</span>
            }
<span class="fc" id="L60">            LOGGER.info(</span>
                    &quot;applying default config with {} errors and {} warnings&quot;,
<span class="fc" id="L62">                    validationResult.getErrorCount(),</span>
<span class="fc" id="L63">                    validationResult.getWarningCount());</span>
<span class="fc" id="L64">            configCrudService.save(nexusConfig);</span>
<span class="fc" id="L65">        } else {</span>
<span class="fc" id="L66">            LOGGER.info(&quot;config entries found, do not apply default config&quot;);</span>
        }
<span class="fc" id="L68">    }</span>

    @Override
    public void start() {
        try {
<span class="fc" id="L73">            synchronized (this) {</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">                if (running == false) {</span>
<span class="fc" id="L75">                    applyDefault();</span>
<span class="fc" id="L76">                    running = true;</span>
                }
<span class="fc" id="L78">            }</span>
<span class="fc" id="L79">        } catch (Exception e) {</span>
<span class="fc" id="L80">            throw new NexusRuntimeException(</span>
<span class="fc" id="L81">                    NexusError.builder()</span>
<span class="fc" id="L82">                            .message(&quot;Could not initialize default config&quot;)</span>
<span class="fc" id="L83">                            .build(),</span>
                    e);
<span class="fc" id="L85">        }</span>
<span class="fc" id="L86">    }</span>

    @Override
    public void stop() {
<span class="fc" id="L90">        synchronized (this) {</span>
<span class="fc" id="L91">            running = false;</span>
<span class="fc" id="L92">        }</span>
<span class="fc" id="L93">    }</span>

    @Override
    public boolean isRunning() {
<span class="fc" id="L97">        return running;</span>
    }

    @Override
    public int getPhase() {
<span class="fc" id="L102">        return LifecycleConstants.CONFIG_INITIALIZE;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>