<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfigGraphQLService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.config.service</a> &gt; <span class="el_source">ConfigGraphQLService.java</span></div><h1>ConfigGraphQLService.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.config.service;

import com.evolvsys.app.core.file.model.FileDto;
import com.evolvsys.app.core.graphql.annotation.GraphQLService;
import com.evolvsys.nexuse2e.core.config.model.ConfigValidationResult;
import com.evolvsys.nexuse2e.core.config.model.NexusConfig;
import com.evolvsys.nexuse2e.core.config.model.NexusConfigMerge;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import io.leangen.graphql.annotations.GraphQLMutation;
import io.leangen.graphql.annotations.GraphQLNonNull;
import io.leangen.graphql.annotations.GraphQLQuery;
import io.leangen.graphql.annotations.GraphQLSubscription;
import java.io.IOException;
import java.util.Queue;
import java.util.concurrent.ConcurrentLinkedQueue;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.reactivestreams.Publisher;
import reactor.core.publisher.Flux;
import reactor.core.publisher.FluxSink;

/**
 * @author SvenBarden
 * @since 01.12.2023
 */
@GraphQLService
@RequiredArgsConstructor
<span class="fc" id="L28">@Slf4j</span>
public class ConfigGraphQLService {
<span class="fc" id="L30">    private static final Queue&lt;FluxSink&lt;Boolean&gt;&gt; SUBSCRIBERS = new ConcurrentLinkedQueue&lt;&gt;();</span>
    private final NEXUSe2eConfigService configService;

    public static void notifySubscribers() {
<span class="fc" id="L34">        LOGGER.trace(&quot;notifying {} subscribers about config update&quot;, SUBSCRIBERS.size());</span>
<span class="pc" id="L35">        SUBSCRIBERS.forEach(subscriber -&gt; subscriber.next(Boolean.TRUE));</span>
<span class="fc" id="L36">    }</span>

    public static &lt;T&gt; T notifySubscribers(T result) {
<span class="fc" id="L39">        notifySubscribers();</span>
<span class="fc" id="L40">        return result;</span>
    }

    @GraphQLNonNull
    @GraphQLQuery(name = &quot;config_getCurrentConfig&quot;)
    public NexusConfig getCurrentConfig() {
<span class="nc" id="L46">        return configService.getCurrentConfig();</span>
    }

    @GraphQLNonNull
    @GraphQLQuery(name = &quot;config_merge&quot;)
    public NexusConfigMerge merge(long fileId) {
<span class="nc" id="L52">        return configService.merge(fileId);</span>
    }

    @GraphQLNonNull
    @GraphQLQuery(name = &quot;config_validateFile&quot;)
    public ConfigValidationResult validateFile(long fileId) {
<span class="nc" id="L58">        return configService.validate(fileId);</span>
    }

    @GraphQLNonNull
    @GraphQLQuery(name = &quot;config_validate&quot;)
    public ConfigValidationResult validate(@GraphQLNonNull NexusConfig config) {
<span class="nc" id="L64">        return configService.validate(config);</span>
    }

    @GraphQLNonNull
    @GraphQLMutation(name = &quot;config_saveFile&quot;)
    public NexusConfig save(long fileId) throws NexusException {
<span class="nc" id="L70">        return notifySubscribers(configService.overwrite(fileId));</span>
    }

    @GraphQLNonNull
    @GraphQLMutation(name = &quot;config_saveConfig&quot;)
    public NexusConfig save(@GraphQLNonNull NexusConfig nexusConfig) throws NexusException {
<span class="nc" id="L76">        return notifySubscribers(configService.merge(nexusConfig));</span>
    }

    @GraphQLNonNull
    @GraphQLMutation(name = &quot;config_overwriteConfig&quot;)
    public NexusConfig overwrite(@GraphQLNonNull NexusConfig nexusConfig) throws NexusException {
<span class="nc" id="L82">        return notifySubscribers(configService.overwrite(nexusConfig));</span>
    }

    @GraphQLNonNull
    @GraphQLQuery(name = &quot;config_getCurrentConfigAsFile&quot;)
    public FileDto getCurrentConfigAsFile() throws IOException {
<span class="nc" id="L88">        return configService.currentConfigToFile();</span>
    }

    @GraphQLSubscription(name = &quot;config_subscribeUpdate&quot;)
    public Publisher&lt;Boolean&gt; subscribe() {
<span class="nc" id="L93">        return Flux.create(</span>
<span class="nc" id="L94">                subscriber -&gt; SUBSCRIBERS.add(subscriber.onDispose(() -&gt; SUBSCRIBERS.remove(subscriber))),</span>
                FluxSink.OverflowStrategy.LATEST);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>