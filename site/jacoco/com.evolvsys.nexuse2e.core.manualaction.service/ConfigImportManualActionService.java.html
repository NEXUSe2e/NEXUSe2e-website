<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConfigImportManualActionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.manualaction.service</a> &gt; <span class="el_source">ConfigImportManualActionService.java</span></div><h1>ConfigImportManualActionService.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.manualaction.service;

import com.evolvsys.app.core.auth.service.CurrentUserService;
import com.evolvsys.app.core.file.model.FileEntity;
import com.evolvsys.app.core.file.model.FileStatus;
import com.evolvsys.app.core.file.service.FileFactory;
import com.evolvsys.app.core.system.service.SystemConfigurationProperties;
import com.evolvsys.app.core.user.model.UserEntity;
import com.evolvsys.nexuse2e.core.config.model.NexusConfig;
import com.evolvsys.nexuse2e.core.config.service.ConfigParserService;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.manualaction.model.ConfigImportManualActionEntity;
import com.evolvsys.nexuse2e.core.manualaction.repository.ConfigImportManualActionRepository;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

/**
 * @author SvenBarden
 * @since 07.08.2024
 */
@Service
@RequiredArgsConstructor
<span class="fc" id="L31">@Slf4j</span>
public class ConfigImportManualActionService {
    private final ConfigImportManualActionRepository configImportManualActionRepository;
    private final ConfigParserService configParserService;
    private final FileFactory fileFactory;
    private final SystemConfigurationProperties systemConfigurationProperties;
    private final CurrentUserService currentUserService;

    private FileEntity configToFileEntity(UserEntity userEntity, NexusConfig config, String fileNameSuffix)
            throws NexusException {
<span class="fc" id="L41">        ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span>
        try {
<span class="fc" id="L43">            configParserService.print(outputStream, config);</span>
<span class="nc" id="L44">        } catch (IOException e) {</span>
<span class="nc" id="L45">            throw new NexusException(</span>
<span class="nc" id="L46">                    NexusError.builder()</span>
<span class="nc" id="L47">                            .message(&quot;Could not create output stream for config&quot;)</span>
<span class="nc" id="L48">                            .extension(&quot;suffix&quot;, fileNameSuffix)</span>
<span class="nc" id="L49">                            .build(),</span>
                    e);
<span class="fc" id="L51">        }</span>

<span class="fc" id="L53">        StringBuilder fileName = new StringBuilder(&quot;NEXUSe2e_config_&quot;).append(fileNameSuffix);</span>
<span class="fc" id="L54">        String environmentName = systemConfigurationProperties.getEnvironmentName();</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        if (StringUtils.isNotBlank(environmentName)) {</span>
<span class="fc" id="L56">            fileName.append('_').append(environmentName);</span>
        }
<span class="fc" id="L58">        fileName.append('_')</span>
<span class="fc" id="L59">                .append(DateTimeFormatter.ISO_OFFSET_DATE_TIME.format(</span>
<span class="fc" id="L60">                        ZonedDateTime.now().withNano(0)))</span>
<span class="fc" id="L61">                .append(&quot;.xml&quot;);</span>

<span class="fc" id="L63">        FileEntity fileEntity = fileFactory.create(</span>
<span class="fc" id="L64">                fileName.toString().replaceAll(&quot;[^A-Za-z0-9.\\-_+]&quot;, &quot;_&quot;),</span>
                &quot;text/xml&quot;,
<span class="fc" id="L66">                outputStream.toByteArray(),</span>
                userEntity);
<span class="fc" id="L68">        fileEntity.setStatus(FileStatus.SAVED);</span>
<span class="fc" id="L69">        return fileEntity;</span>
    }

    private void mergeInternal(UserEntity currentUser, NexusConfig oldConfig, NexusConfig newConfig)
            throws NexusException {
<span class="fc" id="L74">        ConfigImportManualActionEntity manualActionEntity = new ConfigImportManualActionEntity();</span>
<span class="fc" id="L75">        manualActionEntity.setOldConfig(configToFileEntity(currentUser, oldConfig, &quot;old&quot;));</span>
<span class="fc" id="L76">        manualActionEntity.setNewConfig(configToFileEntity(currentUser, newConfig, &quot;new&quot;));</span>
<span class="fc" id="L77">        manualActionEntity.setOverwrite(false);</span>
<span class="fc" id="L78">        configImportManualActionRepository.save(manualActionEntity);</span>
<span class="fc" id="L79">        LOGGER.info(&quot;{} {} merged config&quot;, currentUser.getFirstName(), currentUser.getLastName());</span>
<span class="fc" id="L80">    }</span>

    @Transactional(rollbackFor = NexusException.class)
    public void merge(NexusConfig oldConfig, NexusConfig newConfig) throws NexusException {
        try {
<span class="fc" id="L85">            UserEntity currentUser = currentUserService.getCurrentUser();</span>
<span class="fc" id="L86">            mergeInternal(currentUser, oldConfig, newConfig);</span>
<span class="nc" id="L87">        } catch (IllegalStateException e) {</span>
            // no user currently logged in, e.g. during startup or internal calls
<span class="fc" id="L89">        }</span>
<span class="fc" id="L90">    }</span>

    private void overwriteInternal(UserEntity currentUser, NexusConfig oldConfig, NexusConfig newConfig)
            throws NexusException {
<span class="fc" id="L94">        ConfigImportManualActionEntity manualActionEntity = new ConfigImportManualActionEntity();</span>
<span class="fc" id="L95">        manualActionEntity.setOldConfig(configToFileEntity(currentUser, oldConfig, &quot;old&quot;));</span>
<span class="fc" id="L96">        manualActionEntity.setNewConfig(configToFileEntity(currentUser, newConfig, &quot;new&quot;));</span>
<span class="fc" id="L97">        manualActionEntity.setOverwrite(true);</span>
<span class="fc" id="L98">        configImportManualActionRepository.save(manualActionEntity);</span>
<span class="fc" id="L99">        LOGGER.info(&quot;{} {} overwrote config&quot;, currentUser.getFirstName(), currentUser.getLastName());</span>
<span class="fc" id="L100">    }</span>

    @Transactional(rollbackFor = NexusException.class)
    public void overwrite(NexusConfig oldConfig, NexusConfig newConfig) throws NexusException {
        try {
<span class="fc" id="L105">            UserEntity currentUser = currentUserService.getCurrentUser();</span>
<span class="fc" id="L106">            overwriteInternal(currentUser, oldConfig, newConfig);</span>
<span class="fc" id="L107">        } catch (IllegalStateException e) {</span>
            // no user currently logged in, e.g. during startup or internal calls
<span class="fc" id="L109">        }</span>
<span class="fc" id="L110">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>