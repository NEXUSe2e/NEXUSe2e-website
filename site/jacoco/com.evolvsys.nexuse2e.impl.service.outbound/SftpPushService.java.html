<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SftpPushService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.impl.service.outbound</a> &gt; <span class="el_source">SftpPushService.java</span></div><h1>SftpPushService.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.impl.service.outbound;

import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.message.context.ExecutionContext;
import com.evolvsys.nexuse2e.core.message.context.MessageContext;
import com.evolvsys.nexuse2e.core.parameter.ParameterDefinition;
import com.evolvsys.nexuse2e.core.service.NexusOutflowService;
import com.evolvsys.nexuse2e.core.utils.NEXUSe2eFileUtils;
import com.evolvsys.nexuse2e.core.utils.PatternReplaceUtils;
import com.evolvsys.nexuse2e.impl.service.inbound.SftpClientConfig;
import com.evolvsys.nexuse2e.impl.service.inbound.SftpClientWrapper;
import com.evolvsys.nexuse2e.impl.service.inbound.SftpUtils;
import com.evolvsys.nexuse2e.impl.util.FileSaveAware;
import com.evolvsys.nexuse2e.impl.util.SftpParameterAware;
import com.evolvsys.nexuse2e.internal.ContextPayload;
import com.evolvsys.nexuse2e.internal.Message;
import java.time.Duration;
import java.util.ArrayList;
import java.util.List;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;

/**
 * Service to push files to an SFTP server.
 * &lt;p&gt;
 * This service allows for the configuration of SFTP parameters such as host, port, user credentials,
 * and file patterns for saving files on sftp servers.
 * &lt;/p&gt;
 */
<span class="fc" id="L31">@Slf4j</span>
<span class="fc" id="L32">public class SftpPushService extends NexusOutflowService implements FileSaveAware, SftpParameterAware {</span>

    @Override
    public List&lt;ParameterDefinition&gt; parameterDefinitions() {

<span class="fc" id="L37">        List&lt;ParameterDefinition&gt; parameterDefinitions = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L39">        addSftpParameters(parameterDefinitions);</span>

<span class="fc" id="L41">        parameterDefinitions.addAll(List.of(getCreateMissingDirectories(), getTargetFilename(), getTargetDirectory()));</span>

<span class="fc" id="L43">        return parameterDefinitions;</span>
    }

    @Override
    @SuppressWarnings(&quot;PMD.ExceptionAsFlowControl&quot;)
    public MessageContext executeInternal(ExecutionContext executionContext) throws NexusException {
<span class="fc" id="L49">        boolean enableDeprecatedAlgorithms = parameters.value(PARAM_ENABLE_DEPRECATED_ALGORITHMS);</span>
<span class="fc" id="L50">        String hostKeyData = parameters.value(PARAM_HOST_KEY_DATA);</span>
<span class="fc" id="L51">        String hostKeyAlgorithm = parameters.value(PARAM_HOST_KEY_ALGORITHM);</span>
<span class="fc" id="L52">        String host = parameters.value(PARAM_HOST);</span>
<span class="fc" id="L53">        long port = parameters.value(PARAM_PORT);</span>
<span class="fc" id="L54">        String user = parameters.value(PARAM_LOGIN_USERNAME);</span>
<span class="fc" id="L55">        Duration serverConnectTimeout = parameters.value(PARAM_SERVER_CONNECT_TIMEOUT);</span>
<span class="fc" id="L56">        String privateKeyData = parameters.value(PARAM_SSH_KEY_DATA);</span>
<span class="fc" id="L57">        String privateKeyPassword = parameters.value(PARAM_SSH_KEY_PASSWORD);</span>
<span class="fc" id="L58">        String password = parameters.value(PARAM_LOGIN_PASSWORD);</span>
<span class="fc" id="L59">        String filePattern = parameters.value(PARAM_TARGET_FILENAME);</span>
<span class="fc" id="L60">        String targetDirectory = parameters.value(PARAM_TARGET_DIRECTORY);</span>
<span class="fc" id="L61">        boolean createDirectory = parameters.value(PARAM_CREATE_DIRECTORY);</span>
<span class="fc" id="L62">        String serverPath = parameters.value(PARAM_SERVER_PATH);</span>

<span class="fc" id="L64">        SftpClientConfig clientConfig = SftpClientConfig.builder()</span>
<span class="fc" id="L65">                .host(host)</span>
<span class="fc" id="L66">                .port((int) port)</span>
<span class="fc" id="L67">                .user(user)</span>
<span class="fc" id="L68">                .password(password)</span>
<span class="fc" id="L69">                .privateKeyData(privateKeyData)</span>
<span class="fc" id="L70">                .privateKeyPassword(privateKeyPassword)</span>
<span class="fc" id="L71">                .serverRoot(serverPath)</span>
<span class="fc" id="L72">                .enableDeprecatedAlgorithms(enableDeprecatedAlgorithms)</span>
<span class="fc" id="L73">                .hostKeyAlgorithm(hostKeyAlgorithm)</span>
<span class="fc" id="L74">                .hostKeyData(hostKeyData)</span>
<span class="fc" id="L75">                .serverConnectTimeout(serverConnectTimeout)</span>
<span class="fc" id="L76">                .createDirectory(createDirectory)</span>
<span class="fc" id="L77">                .build();</span>

<span class="fc" id="L79">        MessageContext messageContext = executionContext.getMessageContext();</span>
<span class="fc" id="L80">        Message message = executionContext.getMessage();</span>

<span class="fc" id="L82">        try (SftpClientWrapper client = new SftpClientWrapper(clientConfig)) {</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">            if (client.rootNotExists()) {</span>
<span class="fc" id="L85">                throw new NexusException(NexusError.builder()</span>
<span class="fc" id="L86">                        .message(&quot;Server root path does not exist, must be created manually&quot;)</span>
<span class="fc" id="L87">                        .build());</span>
            }

<span class="fc bfc" id="L90" title="All 2 branches covered.">            for (ContextPayload payload : message.getPayloads()) {</span>

<span class="fc" id="L92">                String replacedTargetDirectory =</span>
<span class="fc" id="L93">                        PatternReplaceUtils.replaceTokens(targetDirectory, executionContext, payload);</span>

<span class="fc" id="L95">                replacedTargetDirectory = SftpUtils.cleanupAndValidateRelativePath(replacedTargetDirectory);</span>

<span class="fc bfc" id="L97" title="All 2 branches covered.">                if (StringUtils.isNotBlank(replacedTargetDirectory)) {</span>
<span class="pc bpc" id="L98" title="1 of 4 branches missed.">                    if (createDirectory &amp;&amp; client.notExists(replacedTargetDirectory)) {</span>
<span class="fc" id="L99">                        client.mkDirs(replacedTargetDirectory);</span>
                    }
                }

<span class="fc" id="L103">                String filename = PatternReplaceUtils.replaceTokens(filePattern, executionContext, payload);</span>
                // first validate path for traversal issues
<span class="fc" id="L105">                SftpUtils.validateFilename(filename);</span>
                // clean up special characters in filename
<span class="fc" id="L107">                filename = NEXUSe2eFileUtils.cleanFileName(filename, &quot;_&quot;);</span>
<span class="fc" id="L108">                LOGGER.trace(</span>
                        &quot;applying filePattern {} to payload {} resulted in fileName {}&quot;,
                        filePattern,
                        payload,
                        filename);

<span class="fc" id="L114">                String filePath = replacedTargetDirectory + filename;</span>
<span class="fc" id="L115">                client.persistFile(payload.getContent().getInputStream(), filePath);</span>
<span class="fc" id="L116">            }</span>

<span class="fc" id="L118">        } catch (Exception e) {</span>
<span class="fc" id="L119">            throw new NexusException(</span>
<span class="fc" id="L120">                    NexusError.builder()</span>
<span class="fc" id="L121">                            .message(&quot;Error while connecting to SFTP server&quot;)</span>
<span class="fc" id="L122">                            .build(),</span>
                    e);
<span class="fc" id="L124">        }</span>

<span class="fc" id="L126">        return messageContext;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>