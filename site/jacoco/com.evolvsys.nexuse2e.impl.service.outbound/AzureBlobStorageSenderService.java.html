<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AzureBlobStorageSenderService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.impl.service.outbound</a> &gt; <span class="el_source">AzureBlobStorageSenderService.java</span></div><h1>AzureBlobStorageSenderService.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.impl.service.outbound;

import com.azure.storage.blob.BlobClient;
import com.azure.storage.blob.BlobContainerClient;
import com.azure.storage.blob.BlobServiceClient;
import com.azure.storage.blob.BlobServiceClientBuilder;
import com.azure.storage.common.StorageSharedKeyCredential;
import com.evolvsys.nexuse2e.core.AzureAuthenticationProvider;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.message.context.ExecutionContext;
import com.evolvsys.nexuse2e.core.message.context.MessageContext;
import com.evolvsys.nexuse2e.core.parameter.ParameterDefinition;
import com.evolvsys.nexuse2e.core.parameter.ParameterType;
import com.evolvsys.nexuse2e.core.service.NexusOutflowService;
import com.evolvsys.nexuse2e.core.utils.NEXUSe2eFileUtils;
import com.evolvsys.nexuse2e.core.utils.PatternReplaceUtils;
import com.evolvsys.nexuse2e.impl.util.FileSaveAware;
import com.evolvsys.nexuse2e.internal.ContextPayload;
import com.evolvsys.nexuse2e.internal.Message;
import java.io.BufferedInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.List;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.EnumUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.time.StopWatch;

/**
 * Outflow service to send files to an Azure Blob Storage.
 *
 * @author SvenBarden
 * @since 02.09.2025
 */
<span class="nc" id="L36">@Slf4j</span>
<span class="nc" id="L37">public class AzureBlobStorageSenderService extends NexusOutflowService</span>
        implements AzureAuthenticationProvider, FileSaveAware {
    private static final String PARAM_ENDPOINT_URL = &quot;endpoint_url&quot;;
    private static final String PARAM_CONTAINER_NAME = &quot;container_name&quot;;
    private static final String PARAM_OVERWRITE = &quot;overwrite&quot;;
    private static final String PARAM_AUTHENTICATION_METHOD = &quot;authentication_method&quot;;
    private static final String PARAM_SHARED_ACCOUNT_NAME = &quot;shared_account_name&quot;;
    private static final String PARAM_SHARED_KEY = &quot;shared_key&quot;;

    @Override
    public List&lt;ParameterDefinition&gt; parameterDefinitions() {
<span class="nc" id="L48">        return List.of(</span>
<span class="nc" id="L49">                ParameterDefinition.builder()</span>
<span class="nc" id="L50">                        .name(PARAM_ENDPOINT_URL)</span>
<span class="nc" id="L51">                        .displayName(&quot;Endpoint url&quot;)</span>
<span class="nc" id="L52">                        .description(</span>
                                &quot;Endpoint url for the blob storage (e.g. https://&lt;storage-account-name&gt;.blob.core.windows.net/). If using SAS authentication, the SAS token must be appended to the url and should preferable stored in a secret vault.&quot;)
<span class="nc" id="L54">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="nc" id="L55">                        .required(true)</span>
<span class="nc" id="L56">                        .build(),</span>
<span class="nc" id="L57">                ParameterDefinition.builder()</span>
<span class="nc" id="L58">                        .name(PARAM_CONTAINER_NAME)</span>
<span class="nc" id="L59">                        .displayName(&quot;Container name&quot;)</span>
<span class="nc" id="L60">                        .description(&quot;The name of the container to store the blobs in.&quot;)</span>
<span class="nc" id="L61">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="nc" id="L62">                        .required(true)</span>
<span class="nc" id="L63">                        .build(),</span>
<span class="nc" id="L64">                ParameterDefinition.builder()</span>
<span class="nc" id="L65">                        .name(PARAM_AUTHENTICATION_METHOD)</span>
<span class="nc" id="L66">                        .displayName(&quot;Authentication method&quot;)</span>
<span class="nc" id="L67">                        .description(</span>
                                &quot;The method to authenticate against the blob storage. See help text for more information.&quot;)
<span class="nc" id="L69">                        .type(ParameterType.DROPDOWN_LIST)</span>
<span class="nc" id="L70">                        .option(AuthenticationMethod.SHARED_KEY.name())</span>
<span class="nc" id="L71">                        .option(AuthenticationMethod.TOKEN.name())</span>
<span class="nc" id="L72">                        .option(AuthenticationMethod.SAS.name())</span>
<span class="nc" id="L73">                        .defaultValue(AuthenticationMethod.TOKEN.name())</span>
<span class="nc" id="L74">                        .required(true)</span>
<span class="nc" id="L75">                        .build(),</span>
<span class="nc" id="L76">                createClientIdParameter(),</span>
<span class="nc" id="L77">                createClientSecretParameter(),</span>
<span class="nc" id="L78">                createTenantIdParameter(),</span>
<span class="nc" id="L79">                ParameterDefinition.builder()</span>
<span class="nc" id="L80">                        .name(PARAM_SHARED_ACCOUNT_NAME)</span>
<span class="nc" id="L81">                        .displayName(&quot;Shared Account Name&quot;)</span>
<span class="nc" id="L82">                        .description(</span>
                                &quot;The name of the storage account. Only required when using SHARED_KEY authentication method.&quot;)
<span class="nc" id="L84">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="nc" id="L85">                        .required(false)</span>
<span class="nc" id="L86">                        .build(),</span>
<span class="nc" id="L87">                ParameterDefinition.builder()</span>
<span class="nc" id="L88">                        .name(PARAM_SHARED_KEY)</span>
<span class="nc" id="L89">                        .displayName(&quot;Shared Key&quot;)</span>
<span class="nc" id="L90">                        .description(</span>
                                &quot;The shared key to authenticate against the blob storage. Only required when using SHARED_KEY authentication method.&quot;)
<span class="nc" id="L92">                        .type(ParameterType.PASSWORD)</span>
<span class="nc" id="L93">                        .required(false)</span>
<span class="nc" id="L94">                        .build(),</span>
<span class="nc" id="L95">                getTargetFilename(),</span>
<span class="nc" id="L96">                ParameterDefinition.builder()</span>
<span class="nc" id="L97">                        .name(PARAM_OVERWRITE)</span>
<span class="nc" id="L98">                        .displayName(&quot;Overwrite existing files&quot;)</span>
<span class="nc" id="L99">                        .description(&quot;Whether to overwrite existing files with the same name.&quot;)</span>
<span class="nc" id="L100">                        .type(ParameterType.BOOLEAN)</span>
<span class="nc" id="L101">                        .required(true)</span>
<span class="nc" id="L102">                        .defaultValue(Boolean.FALSE)</span>
<span class="nc" id="L103">                        .build());</span>
    }

    @Override
    public MessageContext executeInternal(ExecutionContext executionContext) throws NexusException {
<span class="nc" id="L108">        String endpoint = parameters.value(PARAM_ENDPOINT_URL);</span>

<span class="nc" id="L110">        BlobServiceClientBuilder clientBuilder = new BlobServiceClientBuilder().endpoint(endpoint);</span>

<span class="nc" id="L112">        AuthenticationMethod authenticationMethod =</span>
<span class="nc" id="L113">                EnumUtils.getEnum(AuthenticationMethod.class, parameters.value(PARAM_AUTHENTICATION_METHOD));</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">        if (authenticationMethod == AuthenticationMethod.SAS) {</span>
            // since SAS authentication is done via the endpoint url, we log a different message here without exposing
            // the url
<span class="nc" id="L118">            LOGGER.trace(&quot;connecting to blob storage with authentication method {}&quot;, authenticationMethod);</span>
        } else {
<span class="nc" id="L120">            LOGGER.trace(</span>
                    &quot;connecting to blob storage at {} with authentication method {}&quot;, endpoint, authenticationMethod);
        }

        //noinspection DataFlowIssue we want to force exhaustive switch here
<span class="nc bnc" id="L125" title="All 3 branches missed.">        clientBuilder = switch (authenticationMethod) {</span>
<span class="nc" id="L126">            case TOKEN -&gt; clientBuilder.credential(getTokenCredential(parameters));</span>
            case SHARED_KEY -&gt; {
<span class="nc" id="L128">                String accountName = parameters.value(PARAM_SHARED_ACCOUNT_NAME);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                if (StringUtils.isBlank(accountName)) {</span>
<span class="nc" id="L130">                    throw new NexusException(NexusError.builder()</span>
<span class="nc" id="L131">                            .message(&quot;Shared account name is required for authentication method SHARED_KEY&quot;)</span>
<span class="nc" id="L132">                            .build());</span>
                }
<span class="nc" id="L134">                String key = parameters.value(PARAM_SHARED_KEY);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                if (StringUtils.isBlank(key)) {</span>
<span class="nc" id="L136">                    throw new NexusException(NexusError.builder()</span>
<span class="nc" id="L137">                            .message(&quot;Shared key is required for authentication method SHARED_KEY&quot;)</span>
<span class="nc" id="L138">                            .build());</span>
                }
<span class="nc" id="L140">                yield clientBuilder.credential(new StorageSharedKeyCredential(accountName, key));</span>
            }
            case SAS -&gt;
<span class="nc" id="L143">                clientBuilder; // SAS authentication is done via the endpoint url, no additional credential needed</span>
        };

<span class="nc" id="L146">        BlobServiceClient blobServiceClient = clientBuilder.buildClient();</span>

<span class="nc" id="L148">        BlobContainerClient blobContainerClient =</span>
<span class="nc" id="L149">                blobServiceClient.getBlobContainerClient(parameters.value(PARAM_CONTAINER_NAME));</span>

<span class="nc" id="L151">        final String filePattern = parameters.value(PARAM_TARGET_FILENAME);</span>

<span class="nc" id="L153">        Message message = executionContext.getMessage();</span>

<span class="nc" id="L155">        boolean overwrite = parameters.value(PARAM_OVERWRITE);</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (ContextPayload payload : message.getPayloads()) {</span>
<span class="nc" id="L158">            String fileName = PatternReplaceUtils.replaceTokens(filePattern, executionContext, payload);</span>
<span class="nc" id="L159">            fileName = NEXUSe2eFileUtils.cleanFileName(fileName, &quot;_&quot;);</span>
<span class="nc" id="L160">            LOGGER.trace(&quot;replaced filename pattern {} to {}&quot;, filePattern, fileName);</span>

            // blobclient upload needs a stream that supports mark/reset, hence we wrap it in a BufferedInputStream
<span class="nc" id="L163">            try (InputStream inputStream = payload.getContent().getInputStream();</span>
<span class="nc" id="L164">                    BufferedInputStream bufferedInputStream = new BufferedInputStream(inputStream)) {</span>
<span class="nc" id="L165">                BlobClient blobClient = blobContainerClient.getBlobClient(fileName);</span>
<span class="nc" id="L166">                StopWatch stopWatch = StopWatch.createStarted();</span>
<span class="nc" id="L167">                blobClient.upload(bufferedInputStream, payload.getSize(), overwrite);</span>
<span class="nc" id="L168">                stop();</span>
<span class="nc" id="L169">                LOGGER.info(</span>
                        &quot;uploaded file {} to container {} in {}.&quot;,
                        fileName,
<span class="nc" id="L172">                        parameters.value(PARAM_CONTAINER_NAME),</span>
<span class="nc" id="L173">                        stopWatch.getDuration());</span>
<span class="nc" id="L174">            } catch (IOException e) {</span>
<span class="nc" id="L175">                LOGGER.error(&quot;error closing payload {} stream after writing file {}&quot;, payload, fileName, e);</span>
<span class="nc" id="L176">            }</span>
<span class="nc" id="L177">        }</span>

<span class="nc" id="L179">        return executionContext.getMessageContext();</span>
    }

<span class="nc" id="L182">    public enum AuthenticationMethod {</span>
<span class="nc" id="L183">        SHARED_KEY,</span>
<span class="nc" id="L184">        TOKEN,</span>
<span class="nc" id="L185">        SAS</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>