<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContextMetaDataMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.message.mapper</a> &gt; <span class="el_source">ContextMetaDataMapper.java</span></div><h1>ContextMetaDataMapper.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.message.mapper;

import com.evolvsys.app.core.mapper.DefaultMapperConfiguration;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusRuntimeException;
import com.evolvsys.nexuse2e.core.message.MetaData;
import com.evolvsys.nexuse2e.core.message.metadata.MetaDataConverterService;
import com.evolvsys.nexuse2e.core.model.entity.MetaDataEntity;
import com.evolvsys.nexuse2e.internal.ContextPayload;
import com.evolvsys.nexuse2e.internal.Message;
import java.util.List;
import java.util.Set;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.mapstruct.Condition;
import org.mapstruct.Mapper;
import org.mapstruct.MappingTarget;
import org.springframework.beans.factory.annotation.Autowired;

/**
 * @author SvenBarden
 * @since 30.01.2024
 */
@Mapper(config = DefaultMapperConfiguration.class)
<span class="fc" id="L25">@Slf4j</span>
<span class="fc" id="L26">public abstract class ContextMetaDataMapper {</span>
    private MetaDataConverterService metaDataConverterService;

    @Autowired
    protected void config(MetaDataConverterService metaDataConverterService) {
<span class="fc" id="L31">        this.metaDataConverterService = metaDataConverterService;</span>
<span class="fc" id="L32">    }</span>

    @Condition
    public boolean checkMetaData(Message message, MetaData metaData) {
<span class="fc" id="L36">        return true;</span>
    }

    @Condition
    public boolean checkMetaData(ContextPayload contextPayload, MetaData metaData) {
<span class="fc bfc" id="L41" title="All 2 branches covered.">        for (String key : metaData.keys()) {</span>
<span class="fc" id="L42">            List&lt;Object&gt; values = metaData.get(key);</span>

<span class="fc bfc" id="L44" title="All 2 branches covered.">            for (Object value : values) {</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">                if (value instanceof ContextPayload) {</span>
<span class="fc" id="L46">                    throw new NexusRuntimeException(NexusError.builder()</span>
<span class="fc" id="L47">                            .message(&quot;ContextPayload in MetaData of a ContextPayload is not allowed&quot;)</span>
<span class="fc" id="L48">                            .extension(&quot;metaDataKey&quot;, key)</span>
<span class="fc" id="L49">                            .build());</span>
                }
<span class="fc" id="L51">            }</span>
<span class="fc" id="L52">        }</span>
<span class="fc" id="L53">        return true;</span>
    }

    public void updateEntityMetaData(MetaData metaData, @MappingTarget Set&lt;MetaDataEntity&gt; metaDataEntities) {
<span class="pc bpc" id="L57" title="1 of 4 branches missed.">        if (metaData == null || CollectionUtils.isEmpty(metaData.keys())) {</span>
<span class="fc" id="L58">            LOGGER.trace(&quot;remove {} metaData&quot;, metaDataEntities.size());</span>
<span class="fc" id="L59">            metaDataEntities.clear();</span>
        } else {
<span class="fc" id="L61">            Set&lt;String&gt; categories = metaData.categories();</span>

<span class="fc bfc" id="L63" title="All 2 branches covered.">            metaDataEntities.removeIf(metaDataEntity -&gt; categories.contains(metaDataEntity.getCategory()) == false);</span>

<span class="fc bfc" id="L65" title="All 2 branches covered.">            for (String category : categories) {</span>
<span class="fc" id="L66">                Set&lt;String&gt; keys = metaData.keys(category);</span>

<span class="fc" id="L68">                metaDataEntities.removeIf(</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">                        metaDataEntity -&gt; metaDataEntity.getCategory().equals(category)</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">                                &amp;&amp; (keys.contains(metaDataEntity.getName()) == false));</span>

<span class="fc bfc" id="L72" title="All 2 branches covered.">                for (String key : keys) {</span>
<span class="fc" id="L73">                    List&lt;Object&gt; values = metaData.get(category, key);</span>

<span class="fc" id="L75">                    metaDataEntities.removeIf(</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">                            metaDataEntity -&gt; metaDataEntity.getCategory().equals(category)</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">                                    &amp;&amp; metaDataEntity.getName().equals(key)</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">                                    &amp;&amp; metaDataEntity.getIndex() &gt;= values.size());</span>

<span class="fc bfc" id="L80" title="All 2 branches covered.">                    for (int i = 0; i &lt; values.size(); i++) {</span>
<span class="fc" id="L81">                        Object value = values.get(i);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">                        if (value != null) {</span>
<span class="fc" id="L83">                            final int index = i;</span>
<span class="fc" id="L84">                            MetaDataEntity metaDataEntity = metaDataEntities.stream()</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">                                    .filter(entity -&gt; entity.getCategory().equals(category)</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">                                            &amp;&amp; entity.getIndex() == index</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">                                            &amp;&amp; entity.getName().equals(key))</span>
<span class="fc" id="L88">                                    .findFirst()</span>
<span class="fc" id="L89">                                    .orElseGet(MetaDataEntity::new);</span>
<span class="fc" id="L90">                            metaDataEntity.setCategory(category);</span>
<span class="fc" id="L91">                            metaDataEntity.setName(key);</span>
<span class="fc" id="L92">                            metaDataEntity.setIndex(i);</span>
<span class="fc" id="L93">                            metaDataConverterService.updateEntity(value, metaDataEntity);</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">                            if (metaDataEntity.getId() == null) {</span>
<span class="fc" id="L95">                                metaDataEntities.add(metaDataEntity);</span>
<span class="fc" id="L96">                                LOGGER.trace(&quot;add new metaData Entity&quot;);</span>
                            }
                        }
                    }
<span class="fc" id="L100">                }</span>
<span class="fc" id="L101">            }</span>
        }
<span class="fc" id="L103">    }</span>

    public MetaData metaDataEntitiesToMetaData(Set&lt;MetaDataEntity&gt; metaDataEntities) {
<span class="fc" id="L106">        MetaData metaData = new MetaData();</span>

<span class="fc bfc" id="L108" title="All 2 branches covered.">        for (MetaDataEntity metaDataEntity : metaDataEntities) {</span>
<span class="fc" id="L109">            Object value = metaDataConverterService.getValue(metaDataEntity);</span>

<span class="fc" id="L111">            metaData.add(metaDataEntity.getCategory(), metaDataEntity.getName(), value);</span>
<span class="fc" id="L112">        }</span>

<span class="fc" id="L114">        return metaData;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>