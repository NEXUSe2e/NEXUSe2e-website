<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContextPayloadMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.message.mapper</a> &gt; <span class="el_source">ContextPayloadMapper.java</span></div><h1>ContextPayloadMapper.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.message.mapper;

import com.evolvsys.app.core.mapper.DefaultMapperConfiguration;
import com.evolvsys.nexuse2e.core.message.payload.content.PayloadContent;
import com.evolvsys.nexuse2e.core.message.payload.content.PayloadContentFactory;
import com.evolvsys.nexuse2e.core.message.payload.model.BinaryEntity;
import com.evolvsys.nexuse2e.core.message.payload.model.PayloadEntity;
import com.evolvsys.nexuse2e.core.message.payload.repository.BinaryRepository;
import com.evolvsys.nexuse2e.internal.ContextPayload;
import java.util.Collection;
import java.util.List;
import java.util.Optional;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.hibernate.engine.jdbc.BlobProxy;
import org.mapstruct.Condition;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.MappingTarget;
import org.springframework.beans.factory.annotation.Autowired;

/**
 * @author SvenBarden
 * @since 02.02.2024
 */
@Mapper(config = DefaultMapperConfiguration.class, uses = ContextMetaDataMapper.class)
<span class="fc" id="L27">@Slf4j</span>
<span class="fc" id="L28">public abstract class ContextPayloadMapper {</span>
    private PayloadContentFactory payloadContentFactory;
    private BinaryRepository binaryRepository;

    @Autowired
    protected void config(PayloadContentFactory payloadContentFactory, BinaryRepository binaryRepository) {
<span class="fc" id="L34">        this.payloadContentFactory = payloadContentFactory;</span>
<span class="fc" id="L35">        this.binaryRepository = binaryRepository;</span>
<span class="fc" id="L36">    }</span>

    @Condition
    public boolean checkPayloads(Collection&lt;ContextPayload&gt; payloads) {
<span class="fc" id="L40">        return true;</span>
    }

    @Mapping(target = &quot;sequenceNumber&quot;, source = &quot;position&quot;)
    @Mapping(target = &quot;contentId&quot;, source = &quot;name&quot;)
    @Mapping(target = &quot;metaData&quot;, source = &quot;metaDatas&quot;)
    @Mapping(target = &quot;content&quot;, source = &quot;payloadEntity&quot;)
    public abstract ContextPayload entityToPayload(PayloadEntity payloadEntity);

    protected PayloadContent entityToContent(PayloadEntity payloadEntity) {
<span class="fc" id="L50">        return payloadContentFactory.createFromEntity(payloadEntity);</span>
    }

    @Mapping(target = &quot;position&quot;, source = &quot;sequenceNumber&quot;)
    @Mapping(target = &quot;name&quot;, source = &quot;contentId&quot;)
    @Mapping(target = &quot;metaDatas&quot;, source = &quot;metaData&quot;)
    @Mapping(target = &quot;id&quot;, ignore = true)
    @Mapping(target = &quot;version&quot;, ignore = true)
    protected abstract void updateEntity(ContextPayload payload, @MappingTarget PayloadEntity payloadEntity);

    protected BinaryEntity contentToEntity(PayloadContent payloadContent) {
<span class="fc" id="L61">        Long id = payloadContent.getId();</span>
        BinaryEntity binaryEntity;
<span class="fc bfc" id="L63" title="All 2 branches covered.">        if (id == null) {</span>
<span class="fc" id="L64">            binaryEntity = new BinaryEntity();</span>
<span class="fc" id="L65">            binaryEntity.setContent(BlobProxy.generateProxy(payloadContent.getInputStream(), payloadContent.getSize()));</span>
        } else {
<span class="fc" id="L67">            binaryEntity = binaryRepository.findById(id).orElseThrow();</span>
        }
<span class="fc" id="L69">        return binaryEntity;</span>
    }

    public void updateEntities(
            Collection&lt;ContextPayload&gt; payloads, @MappingTarget Collection&lt;PayloadEntity&gt; payloadEntities) {
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (CollectionUtils.isEmpty(payloads)) {</span>
<span class="fc" id="L75">            LOGGER.trace(&quot;removing all payloads&quot;);</span>
<span class="fc" id="L76">            payloadEntities.clear();</span>
        } else {
<span class="fc" id="L78">            List&lt;Long&gt; contextIds = payloads.stream().map(ContextPayload::getId).toList();</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">            payloadEntities.removeIf(payloadEntity -&gt; contextIds.contains(payloadEntity.getId()) == false);</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">            for (ContextPayload payload : payloads) {</span>
<span class="fc" id="L81">                PayloadEntity payloadEntity = Optional.ofNullable(payload.getId())</span>
<span class="fc" id="L82">                        .flatMap(id -&gt; payloadEntities.stream()</span>
<span class="fc" id="L83">                                .filter(entity -&gt; id.equals(entity.getId()))</span>
<span class="fc" id="L84">                                .findFirst())</span>
<span class="fc" id="L85">                        .orElseGet(PayloadEntity::new);</span>
<span class="fc" id="L86">                updateEntity(payload, payloadEntity);</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">                if (payloadEntity.getId() == null) {</span>
<span class="fc" id="L88">                    LOGGER.trace(&quot;adding new payload entity&quot;);</span>
<span class="fc" id="L89">                    payloadEntities.add(payloadEntity);</span>
                } else {
<span class="fc" id="L91">                    LOGGER.trace(&quot;updating payload entity&quot;);</span>
                }
<span class="fc" id="L93">            }</span>
        }
<span class="fc" id="L95">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>