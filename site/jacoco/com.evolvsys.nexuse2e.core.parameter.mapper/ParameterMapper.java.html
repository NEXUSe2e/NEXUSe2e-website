<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ParameterMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.parameter.mapper</a> &gt; <span class="el_source">ParameterMapper.java</span></div><h1>ParameterMapper.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.parameter.mapper;

import com.evolvsys.app.core.auth.model.CurrentUserData;
import com.evolvsys.app.core.exception.GeneralErrorException;
import com.evolvsys.app.core.mapper.BaseDtoEntityMapper;
import com.evolvsys.app.core.mapper.DefaultMapperConfiguration;
import com.evolvsys.app.core.mapper.interceptor.InterceptingMappingContext;
import com.evolvsys.nexuse2e.core.model.entity.ParameterEntity;
import com.evolvsys.nexuse2e.core.parameter.ParameterDefinition;
import com.evolvsys.nexuse2e.core.parameter.converter.TypeConverter;
import com.evolvsys.nexuse2e.core.parameter.model.ParameterDto;
import com.evolvsys.nexuse2e.core.parameter.repository.ParameterRepository;
import com.evolvsys.nexuse2e.core.parameter.service.ParameterConverterRegistry;
import java.util.Collection;
import java.util.List;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.mapstruct.*;
import org.springframework.beans.factory.annotation.Autowired;

/**
 * @author Florian Drees
 * @since 04.12.2023
 */
@Mapper(config = DefaultMapperConfiguration.class)
<span class="fc" id="L27">@Slf4j</span>
<span class="fc" id="L28">public abstract class ParameterMapper extends BaseDtoEntityMapper&lt;ParameterDto, ParameterEntity&gt; {</span>
    private ParameterRepository parameterRepository;
    private ParameterConverterRegistry parameterConverterRegistry;

    @Autowired
    protected void config(ParameterRepository parameterRepository, ParameterConverterRegistry parameterConverterUtils) {
<span class="fc" id="L34">        this.parameterRepository = parameterRepository;</span>
<span class="fc" id="L35">        this.parameterConverterRegistry = parameterConverterUtils;</span>
<span class="fc" id="L36">    }</span>

    @Mapping(target = &quot;defaultValue&quot;, ignore = true)
    @Mapping(target = &quot;defaultStringValues&quot;, ignore = true)
    @Mapping(target = &quot;description&quot;, ignore = true)
    @Mapping(target = &quot;options&quot;, ignore = true)
    @Mapping(target = &quot;required&quot;, ignore = true)
    @Mapping(target = &quot;stringValues&quot;, ignore = true)
    @Mapping(target = &quot;value&quot;, ignore = true)
    @Mapping(target = &quot;displayName&quot;, ignore = true)
    @InheritConfiguration(name = &quot;baseEntityToDto&quot;)
    @Override
    protected abstract ParameterDto entityToDto(
            ParameterEntity entity, @Context InterceptingMappingContext interceptingMappingContext);

    @InheritConfiguration(name = &quot;entityToDto&quot;)
    public abstract ParameterDto entityToDto(
            ParameterEntity entity,
            @Context ParameterDefinition definition,
            @Context InterceptingMappingContext interceptingMappingContext);

    public ParameterDto entityToDto(
            ParameterEntity entity, @Context ParameterDefinition definition, @Context CurrentUserData currentUserData) {
<span class="nc" id="L59">        return entityToDto(</span>
                entity,
                definition,
<span class="nc" id="L62">                InterceptingMappingContext.builder()</span>
<span class="nc" id="L63">                        .currentUserData(currentUserData)</span>
<span class="nc" id="L64">                        .build());</span>
    }

    @Override
    public ParameterEntity idToEntity(Long id, @Context InterceptingMappingContext interceptingMappingContext) {
<span class="fc" id="L69">        return idToEntity(id, interceptingMappingContext, parameterRepository::findById);</span>
    }

    @Mapping(target = &quot;booleanValue&quot;, ignore = true)
    @Mapping(target = &quot;decimalValue&quot;, ignore = true)
    @Mapping(target = &quot;largeStringValue&quot;, ignore = true)
    @Mapping(target = &quot;longValue&quot;, ignore = true)
    @Mapping(target = &quot;stringValue&quot;, ignore = true)
    @Mapping(target = &quot;stringValues&quot;, ignore = true)
    @InheritConfiguration
    @Override
    protected abstract void updateEntity(
            ParameterDto dto,
            @MappingTarget ParameterEntity entity,
            @Context InterceptingMappingContext interceptingMappingContext);

    @Mapping(target = &quot;defaultStringValues&quot;, ignore = true)
    @Mapping(target = &quot;version&quot;, ignore = true)
    @Mapping(target = &quot;typeAccess&quot;, ignore = true)
    @Mapping(target = &quot;propertyAccess&quot;, ignore = true)
    @Mapping(target = &quot;metaData&quot;, ignore = true)
    @Mapping(target = &quot;id&quot;, ignore = true)
    @Mapping(target = &quot;value&quot;, ignore = true)
    @Mapping(target = &quot;stringValues&quot;, ignore = true)
    @Mapping(target = &quot;defaultValue&quot;, ignore = true)
    protected abstract void updateDto(ParameterDefinition definition, @MappingTarget ParameterDto dto);

    public ParameterDto definitionToDto(ParameterDefinition definition, CurrentUserData currentUserData) {
<span class="nc" id="L97">        return entityToDto(</span>
                new ParameterEntity(),
                definition,
<span class="nc" id="L100">                InterceptingMappingContext.builder()</span>
<span class="nc" id="L101">                        .currentUserData(currentUserData)</span>
<span class="nc" id="L102">                        .build());</span>
    }

    protected ParameterDto definitionToDto(
            ParameterDefinition definition, @Context InterceptingMappingContext interceptingMappingContext) {
<span class="fc bfc" id="L107" title="All 2 branches covered.">        return definition == null ? null : entityToDto(new ParameterEntity(), definition, interceptingMappingContext);</span>
    }

    public void updateEntities(
            Collection&lt;ParameterDto&gt; dtos,
            @MappingTarget Collection&lt;ParameterEntity&gt; entities,
            @Context InterceptingMappingContext interceptingMappingContext) {

<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (CollectionUtils.isEmpty(dtos)) {</span>
<span class="fc" id="L116">            entities.clear();</span>
        } else {
<span class="fc" id="L118">            List&lt;String&gt; dtoParamNames =</span>
<span class="fc" id="L119">                    dtos.stream().map(ParameterDto::getName).toList();</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            entities.removeIf(parameterEntity -&gt; dtoParamNames.contains(parameterEntity.getName()) == false);</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">            for (ParameterDto parameterDto : dtos) {</span>
<span class="fc" id="L122">                ParameterEntity parameterEntity = entities.stream()</span>
<span class="fc" id="L123">                        .filter(entity -&gt; entity.getName().equalsIgnoreCase(parameterDto.getName()))</span>
<span class="fc" id="L124">                        .findFirst()</span>
<span class="fc" id="L125">                        .orElse(null);</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">                if (parameterEntity == null) {</span>
<span class="fc" id="L127">                    parameterEntity = new ParameterEntity();</span>
<span class="fc" id="L128">                    entities.add(parameterEntity);</span>
                }
<span class="fc" id="L130">                updateEntity(parameterDto, parameterEntity, interceptingMappingContext);</span>
<span class="fc" id="L131">            }</span>
        }
<span class="fc" id="L133">    }</span>

    @Condition
    public boolean checkParameters(Collection&lt;ParameterDto&gt; parameterDtos) {
<span class="nc" id="L137">        return true;</span>
    }

    @BeforeMapping
    protected void beforeUpdateEntity(ParameterDto dto, @MappingTarget ParameterEntity entity) {
<span class="pc bpc" id="L142" title="2 of 6 branches missed.">        if (dto.getType() != null &amp;&amp; entity.getType() != null &amp;&amp; dto.getType() != entity.getType()) {</span>
<span class="nc" id="L143">            throw new GeneralErrorException(&quot;parameter type is not allowed to be changed&quot;);</span>
        }
<span class="fc" id="L145">    }</span>

    @AfterMapping
    protected void afterEntityToDto(
            ParameterEntity entity,
            @MappingTarget ParameterDto dto,
            @Context ParameterDefinition definition,
            @Context InterceptingMappingContext interceptingMappingContext) {
<span class="fc" id="L153">        updateDto(definition, dto);</span>
<span class="fc" id="L154">    }</span>

    @AfterMapping
    protected void afterEntityToDto(ParameterEntity entity, @MappingTarget ParameterDto dto) {
<span class="pc bpc" id="L158" title="1 of 4 branches missed.">        if (entity != null &amp;&amp; entity.getType() != null) {</span>
<span class="fc" id="L159">            TypeConverter&lt;Object, Object&gt; typeConverter = parameterConverterRegistry.getTypeConverter(entity.getType());</span>
<span class="fc" id="L160">            Object dtoValue = typeConverter.toDtoValue(entity);</span>
<span class="fc" id="L161">            LOGGER.trace(</span>
                    &quot;parameter {}: set value {} of entity into dto [ afterEntityToDto(entity, dto) ]&quot;,
<span class="fc" id="L163">                    dto.getName(),</span>
                    dtoValue);
<span class="fc" id="L165">            typeConverter.getDtoSetter().apply(dto, dtoValue);</span>
        }
<span class="fc" id="L167">    }</span>

    @AfterMapping
    protected void afterUpdateDto(ParameterDefinition definition, @MappingTarget ParameterDto dto) {

<span class="fc" id="L172">        TypeConverter&lt;Object, Object&gt; typeConverter = parameterConverterRegistry.getTypeConverter(definition.getType());</span>

<span class="fc" id="L174">        Object defaultDtoValue = typeConverter.toDtoValue(</span>
<span class="fc" id="L175">                typeConverter.getDefinitionDefaultGetter().apply(definition));</span>
<span class="fc" id="L176">        typeConverter.getDtoDefaultSetter().apply(dto, defaultDtoValue);</span>

<span class="fc bfc" id="L178" title="All 2 branches covered.">        if (dto.getId() == null) {</span>
            // entity does not exist so the default value is preset
<span class="fc" id="L180">            LOGGER.trace(</span>
                    &quot;parameter '{}': set default value {} for parameter type {} as dto value&quot;,
<span class="fc" id="L182">                    dto.getName(),</span>
                    defaultDtoValue,
<span class="fc" id="L184">                    dto.getType().name());</span>
<span class="fc" id="L185">            typeConverter.getDtoSetter().apply(dto, defaultDtoValue);</span>
        }

<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (StringUtils.isBlank(dto.getDisplayName())) {</span>
<span class="fc" id="L189">            dto.setDisplayName(StringUtils.capitalize(dto.getName()));</span>
        }
<span class="fc" id="L191">    }</span>

    @AfterMapping
    protected void afterUpdateEntity(ParameterDto dto, @MappingTarget ParameterEntity entity) {
<span class="fc" id="L195">        TypeConverter&lt;Object, Object&gt; typeConverter = parameterConverterRegistry.getTypeConverter(dto.getType());</span>
<span class="fc" id="L196">        typeConverter.updateFromDto(entity, dto);</span>
<span class="fc" id="L197">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>