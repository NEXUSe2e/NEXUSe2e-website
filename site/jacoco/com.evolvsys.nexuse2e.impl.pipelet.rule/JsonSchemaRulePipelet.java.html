<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JsonSchemaRulePipelet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.impl.pipelet.rule</a> &gt; <span class="el_source">JsonSchemaRulePipelet.java</span></div><h1>JsonSchemaRulePipelet.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.impl.pipelet.rule;

import com.evolvsys.nexuse2e.core.component.Pipelet;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.exception.NexusRuntimeException;
import com.evolvsys.nexuse2e.core.message.context.ExecutionContext;
import com.evolvsys.nexuse2e.core.parameter.ParameterDefinition;
import com.evolvsys.nexuse2e.core.parameter.ParameterType;
import com.evolvsys.nexuse2e.internal.ContextPayload;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.networknt.schema.*;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.List;
import java.util.Set;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.io.FileUtils;
import org.apache.commons.lang3.StringUtils;

/**
 * @author SvenBarden
 * @since 25.07.2024
 */
<span class="fc" id="L30">@Slf4j</span>
<span class="fc" id="L31">public class JsonSchemaRulePipelet extends Pipelet {</span>
    private static final String PARAM_SCHEMA_FILE_PATH = &quot;schema_file_path&quot;;
    private static final String PARAM_SCHEMA_FILE_CONTENT = &quot;schema_file_content&quot;;
    private static final String PARAM_SCHEMA_VERSION = &quot;schema_version&quot;;
    private static final String PARAM_CHECK_MISSING_PAYLOAD = &quot;check_missing_payload&quot;;

    @Override
    public List&lt;ParameterDefinition&gt; parameterDefinitions() {
<span class="fc" id="L39">        return List.of(</span>
<span class="fc" id="L40">                ParameterDefinition.builder()</span>
<span class="fc" id="L41">                        .name(PARAM_SCHEMA_FILE_PATH)</span>
<span class="fc" id="L42">                        .displayName(&quot;File Path to JSON Schema&quot;)</span>
<span class="fc" id="L43">                        .description(&quot;The full path to the JSON schema file for payload validation.&quot;)</span>
<span class="fc" id="L44">                        .required(false)</span>
<span class="fc" id="L45">                        .type(ParameterType.TRIMMED_STRING)</span>
<span class="fc" id="L46">                        .build(),</span>
<span class="fc" id="L47">                ParameterDefinition.builder()</span>
<span class="fc" id="L48">                        .name(PARAM_SCHEMA_FILE_CONTENT)</span>
<span class="fc" id="L49">                        .displayName(&quot;JSON Schema Content&quot;)</span>
<span class="fc" id="L50">                        .description(</span>
                                &quot;Holds the text content of the JSON Schema. If configured, its used instead of the file path.&quot;)
<span class="fc" id="L52">                        .required(false)</span>
<span class="fc" id="L53">                        .type(ParameterType.LARGE_STRING)</span>
<span class="fc" id="L54">                        .build(),</span>
<span class="fc" id="L55">                ParameterDefinition.builder()</span>
<span class="fc" id="L56">                        .name(PARAM_SCHEMA_VERSION)</span>
<span class="fc" id="L57">                        .displayName(&quot;Schema version&quot;)</span>
<span class="fc" id="L58">                        .description(&quot;The schema version to use for validation.&quot;)</span>
<span class="fc" id="L59">                        .type(ParameterType.DROPDOWN_LIST)</span>
<span class="fc" id="L60">                        .option(SchemaId.V4)</span>
<span class="fc" id="L61">                        .option(SchemaId.V6)</span>
<span class="fc" id="L62">                        .option(SchemaId.V7)</span>
<span class="fc" id="L63">                        .option(SchemaId.V201909)</span>
<span class="fc" id="L64">                        .option(SchemaId.V202012)</span>
<span class="fc" id="L65">                        .required(true)</span>
<span class="fc" id="L66">                        .defaultValue(SchemaId.V7)</span>
<span class="fc" id="L67">                        .build(),</span>
<span class="fc" id="L68">                ParameterDefinition.builder()</span>
<span class="fc" id="L69">                        .name(PARAM_CHECK_MISSING_PAYLOAD)</span>
<span class="fc" id="L70">                        .displayName(&quot;Check for missing payload&quot;)</span>
<span class="fc" id="L71">                        .description(&quot;Whether to throw an error if no payload is present.&quot;)</span>
<span class="fc" id="L72">                        .type(ParameterType.BOOLEAN)</span>
<span class="fc" id="L73">                        .required(true)</span>
<span class="fc" id="L74">                        .defaultValue(Boolean.TRUE)</span>
<span class="fc" id="L75">                        .build());</span>
    }

    @Override
    public ExecutionContext execute(ExecutionContext executionContext) throws NexusException {
<span class="fc" id="L80">        List&lt;ContextPayload&gt; payloads = executionContext.getMessage().getPayloads();</span>
<span class="fc" id="L81">        boolean checkMissingPayload = getParameters().value(PARAM_CHECK_MISSING_PAYLOAD);</span>

<span class="fc bfc" id="L83" title="All 4 branches covered.">        if (checkMissingPayload &amp;&amp; CollectionUtils.isEmpty(payloads)) {</span>
<span class="fc" id="L84">            throw new NexusException(</span>
<span class="fc" id="L85">                    NexusError.builder().message(&quot;No payloads found&quot;).build());</span>
        }

<span class="fc" id="L88">        JsonSchema schema = getSchema();</span>
<span class="fc" id="L89">        ObjectMapper objectMapper = executionContext.getBeanFactory().getBean(ObjectMapper.class);</span>

<span class="fc bfc" id="L91" title="All 2 branches covered.">        for (ContextPayload payload : payloads) {</span>
            JsonNode jsonNode;
            try {
<span class="fc" id="L94">                jsonNode = objectMapper.readTree(</span>
<span class="fc" id="L95">                        new InputStreamReader(payload.getContent().getInputStream(), StandardCharsets.UTF_8));</span>
<span class="nc" id="L96">            } catch (IOException e) {</span>
<span class="nc" id="L97">                throw new NexusException(</span>
<span class="nc" id="L98">                        NexusError.builder()</span>
<span class="nc" id="L99">                                .message(&quot;Payload could not be converted into json&quot;)</span>
<span class="nc" id="L100">                                .extension(&quot;contentType&quot;, payload.getContentType())</span>
<span class="nc" id="L101">                                .extension(&quot;sequenceNumber&quot;, payload.getSequenceNumber())</span>
<span class="nc" id="L102">                                .extension(&quot;contentId&quot;, payload.getContentId())</span>
<span class="nc" id="L103">                                .build(),</span>
                        e);
<span class="fc" id="L105">            }</span>

<span class="fc" id="L107">            Set&lt;ValidationMessage&gt; errors = schema.validate(jsonNode);</span>

<span class="fc bfc" id="L109" title="All 2 branches covered.">            if (CollectionUtils.isEmpty(errors)) {</span>
<span class="fc" id="L110">                LOGGER.debug(</span>
                        &quot;Payload {}-{} is valid according to schema&quot;,
<span class="fc" id="L112">                        payload.getContentId(),</span>
<span class="fc" id="L113">                        payload.getSequenceNumber());</span>
            } else {
<span class="fc" id="L115">                NexusError nexusError = NexusError.builder()</span>
<span class="fc" id="L116">                        .message(&quot;Payload is not valid according to schema&quot;)</span>
<span class="fc" id="L117">                        .extension(&quot;contentType&quot;, payload.getContentType())</span>
<span class="fc" id="L118">                        .extension(&quot;sequenceNumber&quot;, payload.getSequenceNumber())</span>
<span class="fc" id="L119">                        .extension(&quot;contentId&quot;, payload.getContentId())</span>
<span class="fc" id="L120">                        .extension(</span>
                                &quot;errors&quot;,
<span class="fc" id="L122">                                errors.stream().map(this::errorToString).toList())</span>
<span class="fc" id="L123">                        .build();</span>
<span class="fc" id="L124">                throw new NexusException(nexusError);</span>
            }
<span class="fc" id="L126">        }</span>

<span class="fc" id="L128">        return executionContext;</span>
    }

    private String errorToString(ValidationMessage validationMessage) {
<span class="fc" id="L132">        String baseMessage = validationMessage.getMessage();</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">        if (validationMessage.getSchemaNode().isObject() == false</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">                &amp;&amp; validationMessage.getSchemaNode().isContainerNode() == false) {</span>
<span class="fc" id="L135">            baseMessage += &quot; but was &quot; + validationMessage.getInstanceNode().toString();</span>
        }
<span class="fc" id="L137">        return baseMessage;</span>
    }

    @SuppressFBWarnings(&quot;PATH_TRAVERSAL_IN&quot;)
    private JsonSchema getSchema() throws NexusException {
<span class="fc" id="L142">        JsonSchemaFactory factory =</span>
<span class="fc" id="L143">                JsonSchemaFactory.getInstance(SpecVersion.VersionFlag.fromId(parameters.value(PARAM_SCHEMA_VERSION))</span>
<span class="pc" id="L144">                        .orElseThrow(() -&gt; new NexusRuntimeException(NexusError.builder()</span>
<span class="nc" id="L145">                                .message(&quot;Invalid json schema version&quot;)</span>
<span class="nc" id="L146">                                .extension(&quot;version&quot;, parameters.value(PARAM_SCHEMA_VERSION))</span>
<span class="nc" id="L147">                                .build())));</span>
        JsonSchema schema;

<span class="fc" id="L150">        String schemaFileString = getParameters().value(PARAM_SCHEMA_FILE_CONTENT);</span>
<span class="fc" id="L151">        String schemaFilePath = getParameters().value(PARAM_SCHEMA_FILE_PATH);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (StringUtils.isNotBlank(schemaFileString)) {</span>
<span class="fc" id="L153">            schema = factory.getSchema(schemaFileString);</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        } else if (StringUtils.isNotBlank(schemaFilePath)) {</span>
            try {
<span class="fc" id="L156">                schema = factory.getSchema(FileUtils.openInputStream(new File(schemaFilePath)));</span>
<span class="nc" id="L157">            } catch (IOException e) {</span>
<span class="nc" id="L158">                throw new NexusException(</span>
<span class="nc" id="L159">                        NexusError.builder()</span>
<span class="nc" id="L160">                                .message(&quot;Could not load json schema file&quot;)</span>
<span class="nc" id="L161">                                .extension(&quot;filePath&quot;, schemaFilePath)</span>
<span class="nc" id="L162">                                .build(),</span>
                        e);
<span class="fc" id="L164">            }</span>
        } else {
<span class="nc" id="L166">            throw new NexusException(NexusError.builder()</span>
<span class="nc" id="L167">                    .message(&quot;no valid schema configuration found&quot;)</span>
<span class="nc" id="L168">                    .build());</span>
        }
<span class="fc" id="L170">        return schema;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>