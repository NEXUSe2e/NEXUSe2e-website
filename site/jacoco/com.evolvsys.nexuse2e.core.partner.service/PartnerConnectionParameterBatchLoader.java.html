<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PartnerConnectionParameterBatchLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.partner.service</a> &gt; <span class="el_source">PartnerConnectionParameterBatchLoader.java</span></div><h1>PartnerConnectionParameterBatchLoader.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.partner.service;

import com.evolvsys.app.core.auth.model.CurrentUserData;
import com.evolvsys.app.core.graphql.dataloader.BatchLoaderContext;
import com.evolvsys.app.core.graphql.dataloader.GraphQLBatchLoader;
import com.evolvsys.app.core.graphql.repository.BatchLoaderRepository;
import com.evolvsys.app.core.persistence.model.IdDto;
import com.evolvsys.app.core.persistence.model.IdEntity;
import com.evolvsys.nexuse2e.core.component.ComponentRegistry;
import com.evolvsys.nexuse2e.core.component.RegisteredNexusComponent;
import com.evolvsys.nexuse2e.core.model.entity.ParameterEntity;
import com.evolvsys.nexuse2e.core.model.entity.QPartnerConnectionEntity;
import com.evolvsys.nexuse2e.core.model.entity.ServiceEntity;
import com.evolvsys.nexuse2e.core.parameter.ParameterBatchLoaderHelper;
import com.evolvsys.nexuse2e.core.parameter.model.ParameterDto;
import com.evolvsys.nexuse2e.core.partner.model.PartnerConnectionDto;
import com.evolvsys.nexuse2e.core.service.repository.ServiceRepository;
import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;
import java.util.stream.Collectors;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.dataloader.BatchLoaderEnvironment;
import org.springframework.stereotype.Component;

/**
 * @author SvenBarden
 * @since 26.02.2024
 */
@Component
@RequiredArgsConstructor
<span class="fc" id="L34">@Slf4j</span>
public class PartnerConnectionParameterBatchLoader
        implements GraphQLBatchLoader&lt;PartnerConnectionDto, Set&lt;ParameterDto&gt;&gt; {
    private final BatchLoaderRepository batchLoaderRepository;
    private final ComponentRegistry componentRegistry;
    private final ParameterBatchLoaderHelper parameterBatchLoaderHelper;
    private final ServiceRepository serviceRepository;

    @Override
    public CompletionStage&lt;Map&lt;PartnerConnectionDto, Set&lt;ParameterDto&gt;&gt;&gt; load(
            Set&lt;PartnerConnectionDto&gt; keys, BatchLoaderEnvironment environment) {
<span class="nc" id="L45">        BatchLoaderContext context = environment.getContext();</span>
<span class="nc" id="L46">        CurrentUserData currentUserData = context.getCurrentUserData();</span>

<span class="nc" id="L48">        Set&lt;PartnerConnectionDto&gt; nonNullKeys =</span>
<span class="nc" id="L49">                keys.stream().filter(Objects::nonNull).collect(Collectors.toSet());</span>

        CompletionStage&lt;Map&lt;PartnerConnectionDto, Set&lt;ParameterDto&gt;&gt;&gt; result;
<span class="nc bnc" id="L52" title="All 2 branches missed.">        if (CollectionUtils.isEmpty(nonNullKeys)) {</span>
<span class="nc" id="L53">            result = CompletableFuture.completedStage(new HashMap&lt;&gt;());</span>
        } else {
<span class="nc" id="L55">            result = CompletableFuture.supplyAsync(() -&gt; loadInternal(nonNullKeys, currentUserData));</span>
        }
<span class="nc" id="L57">        return result;</span>
    }

    private Map&lt;PartnerConnectionDto, Set&lt;ParameterDto&gt;&gt; loadInternal(
            Set&lt;PartnerConnectionDto&gt; keys, CurrentUserData currentUserData) {
<span class="nc" id="L62">        Map&lt;PartnerConnectionDto, Set&lt;ParameterDto&gt;&gt; map = new HashMap&lt;&gt;();</span>

<span class="nc" id="L64">        List&lt;Long&gt; idKeys = keys.stream().map(IdDto::getId).toList();</span>

<span class="nc" id="L66">        List&lt;Long&gt; outflowServiceIds = keys.stream()</span>
<span class="nc" id="L67">                .map(PartnerConnectionDto::getOutflowServiceId)</span>
<span class="nc" id="L68">                .distinct()</span>
<span class="nc" id="L69">                .toList();</span>

<span class="nc" id="L71">        Map&lt;Long, String&gt; outflowServiceComponentMap = serviceRepository.findAllById(outflowServiceIds).stream()</span>
<span class="nc" id="L72">                .collect(Collectors.toMap(IdEntity::getId, ServiceEntity::getComponentId));</span>

<span class="nc" id="L74">        Map&lt;Long, Set&lt;ParameterEntity&gt;&gt; entityMap = batchLoaderRepository.loadEntitiesByJoin(</span>
                idKeys, QPartnerConnectionEntity.partnerConnectionEntity.parameters, false);

<span class="nc" id="L77">        Map&lt;Long, List&lt;String&gt;&gt; parameterStringLists = parameterBatchLoaderHelper.getStringList(entityMap);</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">        for (PartnerConnectionDto key : keys) {</span>
<span class="nc" id="L80">            String componentId = outflowServiceComponentMap.get(key.getOutflowServiceId());</span>
<span class="nc" id="L81">            RegisteredNexusComponent component =</span>
<span class="nc" id="L82">                    componentRegistry.getComponent(componentId).orElse(null);</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (component != null) {</span>
<span class="nc" id="L85">                Set&lt;ParameterDto&gt; parameterDtos = parameterBatchLoaderHelper.loadInternalById(</span>
                        component,
                        currentUserData,
<span class="nc" id="L88">                        entityMap.computeIfAbsent(key.getId(), id -&gt; new HashSet&lt;&gt;()),</span>
                        parameterStringLists,
                        false);
<span class="nc" id="L91">                map.put(key, parameterDtos);</span>
            }
<span class="nc" id="L93">        }</span>

<span class="nc" id="L95">        return map;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>