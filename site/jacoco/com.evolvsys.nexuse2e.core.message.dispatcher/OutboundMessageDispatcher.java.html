<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OutboundMessageDispatcher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.message.dispatcher</a> &gt; <span class="el_source">OutboundMessageDispatcher.java</span></div><h1>OutboundMessageDispatcher.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.message.dispatcher;

import com.evolvsys.nexuse2e.core.component.OutflowService;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.exception.NexusRuntimeException;
import com.evolvsys.nexuse2e.core.message.MessageRunner;
import com.evolvsys.nexuse2e.core.message.MessageStatus;
import com.evolvsys.nexuse2e.core.message.context.ExecutionContext;
import com.evolvsys.nexuse2e.core.message.context.MessageContext;
import com.evolvsys.nexuse2e.core.message.state.MessageEventService;
import com.evolvsys.nexuse2e.core.message.state.MessageEventType;
import com.evolvsys.nexuse2e.core.partner.model.ContextConnection;
import com.evolvsys.nexuse2e.core.service.OutflowServiceFactory;
import com.evolvsys.nexuse2e.core.utils.ErrorUtils;
import com.evolvsys.nexuse2e.internal.Message;
import com.evolvsys.nexuse2e.internal.MessageType;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * @author SvenBarden
 * @since 18.01.2024
 */
@RequiredArgsConstructor
<span class="fc" id="L27">@Slf4j</span>
@Component
public class OutboundMessageDispatcher {
    private final OutflowServiceFactory outflowServiceFactory;
    private final MessageEventService messageEventService;
    private final OutboundMessageActionDispatcher outboundMessageActionDispatcher;
    private final MessageRunner messageRunner;

    private void handleSenderError(ExecutionContext executionContext, Throwable e) throws NexusException {
<span class="fc" id="L36">        Message message = executionContext.getMessage();</span>
        try {
<span class="fc" id="L38">            messageEventService.trigger(executionContext, MessageEventType.SEND_ERROR);</span>
<span class="fc" id="L39">            LOGGER.error(</span>
<span class="fc" id="L40">                    &quot;error calling sender service for message {}: {}&quot;, message.getId(), ErrorUtils.aggregate(e), e);</span>
<span class="nc" id="L41">        } catch (Throwable ex) {</span>
<span class="nc" id="L42">            LOGGER.error(</span>
<span class="nc" id="L43">                    &quot;failed handling message error for message {}: {}&quot;, message.getId(), ErrorUtils.aggregate(ex), ex);</span>
<span class="nc" id="L44">            throw new NexusException(</span>
<span class="nc" id="L45">                    NexusError.builder()</span>
<span class="nc" id="L46">                            .message(&quot;failed handling message error for message&quot;)</span>
<span class="nc" id="L47">                            .extension(&quot;messageId&quot;, message.getId())</span>
<span class="nc" id="L48">                            .build(),</span>
                    ex);
<span class="fc" id="L50">        }</span>
<span class="fc" id="L51">    }</span>

    private MessageContext callOutflowService(ExecutionContext executionContext, ContextConnection contextConnection)
            throws NexusException {
<span class="fc" id="L55">        OutflowService outflowService = outflowServiceFactory.get(contextConnection);</span>
<span class="fc" id="L56">        MessageContext messageContext = executionContext.getMessageContext();</span>
        try {
<span class="fc" id="L58">            LOGGER.info(</span>
                    &quot;sending {} message {} to target connection {} for partner {}&quot;,
<span class="fc" id="L60">                    executionContext.getMessage().getType(),</span>
<span class="fc" id="L61">                    executionContext.getMessage().getId(),</span>
<span class="fc" id="L62">                    contextConnection.getConnectionId(),</span>
<span class="fc" id="L63">                    contextConnection.getPartnerId());</span>
<span class="fc" id="L64">            messageContext = outflowService.execute(executionContext);</span>

<span class="fc" id="L66">            messageEventService.trigger(executionContext, MessageEventType.SENT);</span>
<span class="fc" id="L67">        } catch (Throwable e) {</span>
<span class="fc" id="L68">            handleSenderError(executionContext, e);</span>
<span class="fc" id="L69">        }</span>
<span class="fc" id="L70">        return messageContext;</span>
    }

    private MessageContext dispatchSender(ExecutionContext executionContext) throws NexusException {
<span class="fc" id="L74">        MessageContext messageContext = executionContext.getMessageContext();</span>

        try {
<span class="fc" id="L77">            ContextConnection contextConnection = executionContext.getRoute().getTargetConnection();</span>

            // handling reliable connections and missing acknowledgments
<span class="fc bfc" id="L80" title="All 2 branches covered.">            if (executionContext.getMessageType() == MessageType.NORMAL</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                    &amp;&amp; executionContext.getMessage().getMessageStatus() == MessageStatus.WAITING_FOR_ACKNOWLEDGMENT</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">                    &amp;&amp; executionContext.getMessage().getRetries() &gt;= contextConnection.getMaxRetries()) {</span>
<span class="fc" id="L83">                LOGGER.error(</span>
                        &quot;Missing acknowledgment from {} for message {}&quot;,
<span class="fc" id="L85">                        executionContext.getTargetPartnerId(),</span>
<span class="fc" id="L86">                        executionContext.getMessage().getId());</span>
<span class="fc" id="L87">                messageEventService.trigger(executionContext, MessageEventType.WAITING_FOR_ACK_ERROR);</span>
            } else {
<span class="fc" id="L89">                messageContext = callOutflowService(executionContext, contextConnection);</span>
            }
<span class="fc" id="L91">        } catch (NexusRuntimeException e) {</span>
<span class="fc" id="L92">            LOGGER.error(</span>
                    &quot;could not send message {} to action {}: {}&quot;,
<span class="fc" id="L94">                    executionContext.getMessage().getId(),</span>
<span class="fc" id="L95">                    executionContext.getAction().getActionId(),</span>
<span class="fc" id="L96">                    ErrorUtils.aggregate(e),</span>
                    e);
<span class="fc" id="L98">        }</span>

<span class="fc" id="L100">        return messageContext;</span>
    }

    private ExecutionContext dispatchInternal(ExecutionContext executionContext) {
        try {
<span class="fc bfc" id="L105" title="All 2 branches covered.">            if (executionContext.getMessage().getType() == MessageType.NORMAL) {</span>
<span class="fc" id="L106">                executionContext = outboundMessageActionDispatcher.dispatch(executionContext);</span>
            }

<span class="fc" id="L109">            executionContext =</span>
<span class="fc" id="L110">                    dispatchSender(executionContext).createExecutionContext(executionContext.getMessageType());</span>
<span class="fc" id="L111">        } catch (Throwable e) {</span>
<span class="fc" id="L112">            LOGGER.error(&quot;message dispatching failed: {}&quot;, ErrorUtils.aggregate(e), e);</span>
<span class="fc" id="L113">        }</span>
<span class="fc" id="L114">        return executionContext;</span>
    }

    public MessageContext dispatch(ExecutionContext executionContext) throws NexusException {
<span class="fc" id="L118">        MessageContext messageContext = executionContext.getMessageContext();</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">        if (messageContext.getRoute().getTargetConnection().isAsync()) {</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">            if (messageContext.getAction().hasReturnPipeline()) {</span>
<span class="nc" id="L122">                throw new NexusRuntimeException(NexusError.builder()</span>
<span class="nc" id="L123">                        .message(String.format(</span>
                                &quot;Action '%s' in choreography '%s' is declared as async, but has a return pipeline&quot;,
<span class="nc" id="L125">                                messageContext.getActionId(), messageContext.getChoreographyId()))</span>
<span class="nc" id="L126">                        .code(&quot;INVALID_CONFIG&quot;)</span>
<span class="nc" id="L127">                        .extension(&quot;action&quot;, messageContext.getActionId())</span>
<span class="nc" id="L128">                        .extension(&quot;choreography&quot;, messageContext.getChoreographyId())</span>
<span class="nc" id="L129">                        .build());</span>
            }
<span class="fc" id="L131">            messageRunner.createWrappedFuture(</span>
<span class="fc" id="L132">                    messageContext, () -&gt; dispatchInternal(executionContext).getMessageContext());</span>
        } else {
<span class="fc" id="L134">            messageContext = dispatchInternal(executionContext).getMessageContext();</span>
        }

<span class="fc" id="L137">        return messageContext;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>