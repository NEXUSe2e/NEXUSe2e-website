<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CertificateEntityFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.core.certificate.service</a> &gt; <span class="el_source">CertificateEntityFactory.java</span></div><h1>CertificateEntityFactory.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.core.certificate.service;

import com.evolvsys.app.core.file.model.FileEntity;
import com.evolvsys.app.core.file.model.FileStatus;
import com.evolvsys.app.core.file.service.FileFactory;
import com.evolvsys.nexuse2e.core.certificate.CertificateConstants;
import com.evolvsys.nexuse2e.core.certificate.mapper.CertificateInfoMapper;
import com.evolvsys.nexuse2e.core.certificate.model.CertificateEntity;
import com.evolvsys.nexuse2e.core.certificate.model.CertificateType;
import com.evolvsys.nexuse2e.core.certificate.model.KeystoreUpload;
import com.evolvsys.nexuse2e.core.certificate.util.CertificateUtil;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.security.*;
import java.security.cert.Certificate;
import java.security.cert.CertificateEncodingException;
import java.security.cert.CertificateException;
import java.security.cert.X509Certificate;
import java.time.ZonedDateTime;
import java.util.*;
import javax.security.auth.x500.X500Principal;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.ArrayUtils;
import org.apache.tika.config.TikaConfig;
import org.apache.tika.mime.MimeTypeException;
import org.springframework.stereotype.Component;

/**
 * @author SvenBarden
 * @since 06.02.2024
 */
@Component
@RequiredArgsConstructor
<span class="fc" id="L38">@Slf4j</span>
public class CertificateEntityFactory {
    private final CertificateIdGenerator certificateIdGenerator;
    private final FileFactory fileFactory;
    private final CertificateInfoMapper certificateInfoMapper;

    private List&lt;Certificate&gt; getCertificateChain(KeyStore keyStore) throws NexusException {
<span class="fc" id="L45">        List&lt;Certificate&gt; certificates = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L47" title="1 of 2 branches missed.">        if (keyStore != null) {</span>
            try {
<span class="fc" id="L49">                Enumeration&lt;String&gt; aliases = keyStore.aliases();</span>

<span class="pc bpc" id="L51" title="1 of 4 branches missed.">                while (aliases.hasMoreElements() &amp;&amp; certificates.isEmpty()) {</span>
<span class="fc" id="L52">                    String alias = aliases.nextElement();</span>
<span class="fc" id="L53">                    Certificate[] certificateChain = keyStore.getCertificateChain(alias);</span>

<span class="pc bpc" id="L55" title="1 of 2 branches missed.">                    if (ArrayUtils.isNotEmpty(certificateChain)) {</span>
<span class="fc" id="L56">                        CollectionUtils.addAll(certificates, certificateChain);</span>
                    }
<span class="fc" id="L58">                }</span>
<span class="nc" id="L59">            } catch (KeyStoreException e) {</span>
<span class="nc" id="L60">                throw new NexusException(</span>
<span class="nc" id="L61">                        NexusError.builder()</span>
<span class="nc" id="L62">                                .message(&quot;error getting certificate chain from keystore&quot;)</span>
<span class="nc" id="L63">                                .build(),</span>
                        e);
<span class="fc" id="L65">            }</span>
        }

<span class="fc" id="L68">        return certificates;</span>
    }

    private boolean isSelfSigned(X509Certificate certificate) {
<span class="fc" id="L72">        X500Principal subjectX500Principal = certificate.getSubjectX500Principal();</span>
<span class="fc" id="L73">        X500Principal issuerX500Principal = certificate.getIssuerX500Principal();</span>

<span class="fc" id="L75">        return subjectX500Principal.equals(issuerX500Principal);</span>
    }

    private CertificateEntity fromX509(X509Certificate certificate, CertificateType certificateType)
            throws NexusException {
        CertificateEntity certificateEntity;

        try {
<span class="fc" id="L83">            String id = certificateIdGenerator</span>
<span class="fc" id="L84">                    .createCertificateId(certificate)</span>
<span class="pc" id="L85">                    .orElseThrow(() -&gt; new NexusException(NexusError.builder()</span>
<span class="nc" id="L86">                            .message(&quot;could not create id from certificate&quot;)</span>
<span class="nc" id="L87">                            .build()));</span>

<span class="fc" id="L89">            certificateEntity = new CertificateEntity();</span>
<span class="fc" id="L90">            certificateEntity.setName(id);</span>
<span class="fc" id="L91">            certificateEntity.setType(certificateType);</span>
<span class="fc" id="L92">            certificateEntity.setFile(createFileEntity(id, typeToMimeType(certificateType), certificate.getEncoded()));</span>
<span class="fc" id="L93">            certificateEntity.setInfo(certificateInfoMapper.certificateToInfo(certificate));</span>
<span class="nc" id="L94">        } catch (CertificateEncodingException e) {</span>
<span class="nc" id="L95">            throw new NexusException(</span>
<span class="nc" id="L96">                    NexusError.builder().message(&quot;could not encode certificate&quot;).build(), e);</span>
<span class="fc" id="L97">        }</span>

<span class="fc" id="L99">        return certificateEntity;</span>
    }

    public static String typeToMimeType(CertificateType certificateType) {
<span class="fc bfc" id="L103" title="All 2 branches covered.">        return switch (certificateType) {</span>
<span class="fc" id="L104">            case CA, PARTNER -&gt; &quot;application/x-x509-ca-cert&quot;;</span>
<span class="fc" id="L105">            case LOCAL -&gt; &quot;application/x-pkcs12&quot;;</span>
        };
    }

    private FileEntity createFileEntity(String name, String mimeType, byte[] content) {
        String fileName;
        try {
<span class="fc" id="L112">            fileName = name</span>
<span class="fc" id="L113">                    + TikaConfig.getDefaultConfig()</span>
<span class="fc" id="L114">                            .getMimeRepository()</span>
<span class="fc" id="L115">                            .forName(mimeType)</span>
<span class="fc" id="L116">                            .getExtension();</span>
<span class="nc" id="L117">        } catch (MimeTypeException e) {</span>
<span class="nc" id="L118">            LOGGER.error(&quot;could not get file extension for cert {} with type {}&quot;, name, mimeType, e);</span>
<span class="nc" id="L119">            fileName = name;</span>
<span class="fc" id="L120">        }</span>
<span class="fc" id="L121">        FileEntity fileEntity = fileFactory.create(fileName, mimeType, content);</span>
<span class="fc" id="L122">        fileEntity.setStatus(FileStatus.SAVED);</span>
<span class="fc" id="L123">        return fileEntity;</span>
    }

    private void addOnlyNewCertificate(
            X509Certificate x509Certificate,
            Collection&lt;String&gt; installedFingerprints,
            SequencedCollection&lt;CertificateEntity&gt; certificateEntities)
            throws CertificateEncodingException, NexusException {
<span class="fc" id="L131">        String sha1Fingerprint = CertificateUtil.getSha1Fingerprint(x509Certificate);</span>

<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (installedFingerprints.contains(sha1Fingerprint)) {</span>
<span class="fc" id="L134">            LOGGER.trace(&quot;fingerprint {} is already installed&quot;, sha1Fingerprint);</span>
        } else {
<span class="fc" id="L136">            CertificateEntity certificateEntity = fromX509(x509Certificate, CertificateType.CA);</span>
<span class="fc" id="L137">            certificateEntity.setEnabled(ZonedDateTime.now());</span>
<span class="fc" id="L138">            certificateEntity.setActive(true);</span>
<span class="fc" id="L139">            certificateEntities.add(certificateEntity);</span>
        }
<span class="fc" id="L141">    }</span>

    public List&lt;CertificateEntity&gt; createMissingCaEntitiesFromCaKeyStore(
            Collection&lt;String&gt; installedFingerprints, KeyStore keyStore)
            throws NexusException, CertificateEncodingException {
<span class="nc" id="L146">        List&lt;CertificateEntity&gt; certificateEntities = new ArrayList&lt;&gt;();</span>

        try {
<span class="nc" id="L149">            Enumeration&lt;String&gt; aliases = keyStore.aliases();</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">            while (aliases.hasMoreElements()) {</span>
<span class="nc" id="L152">                String alias = aliases.nextElement();</span>

<span class="nc" id="L154">                X509Certificate x509Certificate = (X509Certificate) keyStore.getCertificate(alias);</span>
<span class="nc" id="L155">                addOnlyNewCertificate(x509Certificate, installedFingerprints, certificateEntities);</span>
<span class="nc" id="L156">            }</span>
<span class="nc" id="L157">        } catch (KeyStoreException e) {</span>
<span class="nc" id="L158">            throw new NexusException(</span>
<span class="nc" id="L159">                    NexusError.builder()</span>
<span class="nc" id="L160">                            .message(&quot;Error loading aliases from keystore&quot;)</span>
<span class="nc" id="L161">                            .build(),</span>
                    e);
<span class="nc" id="L163">        }</span>

<span class="nc" id="L165">        LOGGER.trace(&quot;created {} certs from keystore&quot;, certificateEntities.size());</span>

<span class="nc" id="L167">        return certificateEntities;</span>
    }

    public List&lt;CertificateEntity&gt; createMissingCaEntities(Collection&lt;String&gt; installedFingerprints, KeyStore keyStore)
            throws NexusException, CertificateEncodingException {
<span class="fc" id="L172">        List&lt;CertificateEntity&gt; certificateEntities = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L173">        List&lt;Certificate&gt; certificateChain = getCertificateChain(keyStore);</span>

<span class="fc" id="L175">        LOGGER.trace(&quot;got {} certs from keystore&quot;, certificateChain.size());</span>

<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        if (CollectionUtils.isNotEmpty(certificateChain)) {</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            for (int i = 0; i &lt; certificateChain.size(); i++) {</span>
<span class="fc" id="L179">                Certificate certificate = certificateChain.get(i);</span>
<span class="fc" id="L180">                X509Certificate x509Certificate = (X509Certificate) certificate;</span>

<span class="pc bpc" id="L182" title="1 of 4 branches missed.">                if (i &gt; 0 || isSelfSigned(x509Certificate)) {</span>
<span class="fc" id="L183">                    addOnlyNewCertificate(x509Certificate, installedFingerprints, certificateEntities);</span>
                }
            }
        }

<span class="fc" id="L188">        return certificateEntities;</span>
    }

    public CertificateEntity createFromPKCS12(KeyStore keyStore, KeystoreUpload keystoreUpload) throws NexusException {
<span class="fc" id="L192">        CertificateEntity certificateEntity = new CertificateEntity();</span>

<span class="fc" id="L194">        PrivateKey privateKey = CertificateKeystoreUtils.getPrivateKey(keyStore, null);</span>
<span class="fc" id="L195">        List&lt;Certificate&gt; certificateChain = getCertificateChain(keyStore);</span>

<span class="pc bpc" id="L197" title="1 of 2 branches missed.">        if (CollectionUtils.isEmpty(certificateChain)) {</span>
<span class="nc" id="L198">            throw new NexusException(NexusError.builder()</span>
<span class="nc" id="L199">                    .message(&quot;cannot import certificate without certificate chain&quot;)</span>
<span class="nc" id="L200">                    .build());</span>
        }

        try {
<span class="fc" id="L204">            KeyStore newKeystore = KeyStore.getInstance(</span>
                    CertificateConstants.DEFAULT_KEY_STORE_TYPE, CertificateConstants.DEFAULT_JCE_PROVIDER);
<span class="fc" id="L206">            newKeystore.load(null, null);</span>

<span class="fc" id="L208">            String id = certificateIdGenerator</span>
<span class="fc" id="L209">                    .createCertificateId((X509Certificate) certificateChain.getFirst())</span>
<span class="pc" id="L210">                    .orElseThrow(() -&gt; new NexusException(NexusError.builder()</span>
<span class="nc" id="L211">                            .message(&quot;could not create id from certificate&quot;)</span>
<span class="nc" id="L212">                            .build()));</span>

<span class="fc" id="L214">            newKeystore.setKeyEntry(</span>
                    id,
                    privateKey,
<span class="fc" id="L217">                    keystoreUpload.getPassword().toCharArray(),</span>
<span class="fc" id="L218">                    certificateChain.toArray(new Certificate[0]));</span>
<span class="fc" id="L219">            ByteArrayOutputStream outputStream = new ByteArrayOutputStream();</span>
<span class="fc" id="L220">            newKeystore.store(outputStream, keystoreUpload.getPassword().toCharArray());</span>

<span class="fc" id="L222">            certificateEntity.setName(id);</span>
<span class="fc" id="L223">            certificateEntity.setType(CertificateType.LOCAL);</span>
<span class="fc" id="L224">            certificateEntity.setPassword(keystoreUpload.getPassword());</span>
<span class="fc" id="L225">            certificateEntity.setFile(</span>
<span class="fc" id="L226">                    createFileEntity(id, typeToMimeType(CertificateType.LOCAL), outputStream.toByteArray()));</span>
<span class="fc" id="L227">            certificateEntity.setInfo(</span>
<span class="fc" id="L228">                    certificateInfoMapper.certificateToInfo((X509Certificate) certificateChain.getFirst()));</span>

<span class="nc" id="L230">        } catch (KeyStoreException</span>
                | NoSuchProviderException
                | CertificateException
                | IOException
                | NoSuchAlgorithmException e) {
<span class="nc" id="L235">            throw new NexusException(</span>
<span class="nc" id="L236">                    NexusError.builder()</span>
<span class="nc" id="L237">                            .message(&quot;could not create certificateEntity from keystore&quot;)</span>
<span class="nc" id="L238">                            .build(),</span>
                    e);
<span class="fc" id="L240">        }</span>

<span class="fc" id="L242">        return certificateEntity;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>