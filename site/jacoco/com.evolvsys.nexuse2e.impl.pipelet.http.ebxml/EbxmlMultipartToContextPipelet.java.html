<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EbxmlMultipartToContextPipelet.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ng-nexus-core</a> &gt; <a href="index.source.html" class="el_package">com.evolvsys.nexuse2e.impl.pipelet.http.ebxml</a> &gt; <span class="el_source">EbxmlMultipartToContextPipelet.java</span></div><h1>EbxmlMultipartToContextPipelet.java</h1><pre class="source lang-java linenums">package com.evolvsys.nexuse2e.impl.pipelet.http.ebxml;

import com.evolvsys.nexuse2e.core.component.Pipelet;
import com.evolvsys.nexuse2e.core.constants.HttpConstants;
import com.evolvsys.nexuse2e.core.ebxml.EbxmlUtils;
import com.evolvsys.nexuse2e.core.exception.NexusError;
import com.evolvsys.nexuse2e.core.exception.NexusException;
import com.evolvsys.nexuse2e.core.exception.NexusRuntimeException;
import com.evolvsys.nexuse2e.core.message.context.ExecutionContext;
import com.evolvsys.nexuse2e.core.message.payload.content.PayloadContent;
import com.evolvsys.nexuse2e.core.parameter.ParameterDefinition;
import com.evolvsys.nexuse2e.internal.ContextPayload;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeBodyPart;
import jakarta.mail.internet.MimeMessage;
import jakarta.mail.internet.MimeMultipart;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.ArrayUtils;
import org.springframework.http.MediaType;

/**
 * &lt;p&gt;Pipelet for transforming a single payload request into their actual multipart parts.&lt;/p&gt;
 *
 * @author Florian Drees
 * @since 12.12.2023
 */
<span class="fc" id="L34">@Slf4j</span>
<span class="fc" id="L35">public class EbxmlMultipartToContextPipelet extends Pipelet {</span>
    @Override
    @SuppressFBWarnings(&quot;CFS_CONFUSING_FUNCTION_SEMANTICS&quot;)
    public ExecutionContext execute(ExecutionContext executionContext) throws NexusException {
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">        if (executionContext.getDataAsList().size() == 1) {</span>
<span class="fc" id="L40">            byte[] messageData = prepareMessageData(executionContext);</span>

<span class="fc" id="L42">            List&lt;MimeBodyPart&gt; mimeBodyParts = new ArrayList&lt;&gt;();</span>
            try {
<span class="fc" id="L44">                MimeMessage mimeMessage = new MimeMessage(null, new ByteArrayInputStream(messageData));</span>
<span class="fc" id="L45">                MediaType contentType = MediaType.parseMediaType(mimeMessage.getContentType());</span>

<span class="fc bfc" id="L47" title="All 2 branches covered.">                if (MediaType.MULTIPART_RELATED.includes(contentType)) {</span>
<span class="fc" id="L48">                    MimeMultipart mimeMultipart = (MimeMultipart) mimeMessage.getContent();</span>
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">                    if (mimeMultipart.getCount() &gt; 0) {</span>
<span class="fc bfc" id="L50" title="All 2 branches covered.">                        for (int i = 0; i &lt; mimeMultipart.getCount(); i++) {</span>
<span class="fc" id="L51">                            mimeBodyParts.add((MimeBodyPart) mimeMultipart.getBodyPart(i));</span>
                        }
                    } else {
<span class="nc" id="L54">                        LOGGER.error(&quot;MIME message contains no body parts!&quot;);</span>
<span class="nc" id="L55">                        throw new NexusRuntimeException(NexusError.builder()</span>
<span class="nc" id="L56">                                .message(&quot;MIME message contains no body parts!&quot;)</span>
<span class="nc" id="L57">                                .build());</span>
                    }
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">                } else if (&quot;text&quot;.equalsIgnoreCase(contentType.getType())) {</span>
<span class="fc" id="L60">                    MimeBodyPart mimeBodyPart = new MimeBodyPart();</span>
<span class="fc" id="L61">                    mimeBodyPart.setContent(mimeMessage.getContent(), mimeMessage.getContentType());</span>
<span class="fc" id="L62">                    mimeBodyParts.add(mimeBodyPart);</span>
<span class="fc" id="L63">                } else {</span>
<span class="nc" id="L64">                    LOGGER.error(&quot;MIME message doesn't seem to be of type multipart: {}&quot;, mimeMessage.getContentType());</span>
<span class="nc" id="L65">                    throw new NexusRuntimeException(NexusError.builder()</span>
<span class="nc" id="L66">                            .message(&quot;MIME message doesn't seem to be of type multipart: &quot;</span>
<span class="nc" id="L67">                                    + mimeMessage.getContentType())</span>
<span class="nc" id="L68">                            .build());</span>
                }
<span class="fc" id="L70">                String encoding = executionContext.getMetaData().getFirstOrThrows(HttpConstants.ENCODING);</span>

<span class="fc" id="L72">                executionContext.setData(toContextPayloads(mimeBodyParts, encoding));</span>
<span class="nc" id="L73">            } catch (MessagingException | IOException e) {</span>
<span class="nc" id="L74">                throw new NexusException(</span>
<span class="nc" id="L75">                        NexusError.builder()</span>
<span class="nc" id="L76">                                .message(&quot;Error while decoding message&quot;)</span>
<span class="nc" id="L77">                                .extension(&quot;reason&quot;, e.getMessage())</span>
<span class="nc" id="L78">                                .build(),</span>
                        e);
<span class="fc" id="L80">            }</span>
        }
<span class="fc" id="L82">        return executionContext;</span>
    }

    private byte[] prepareMessageData(ExecutionContext executionContext) {
<span class="fc" id="L86">        String prefix = &quot;Mime-Version: 1.0\r\nContent-Type: %s\r\n\r\n&quot;;</span>

<span class="fc" id="L88">        String contentType = executionContext</span>
<span class="fc" id="L89">                .getMetaData()</span>
<span class="fc" id="L90">                .getFirstOrThrows(HttpConstants.CONTENT_TYPE)</span>
<span class="fc" id="L91">                .toString();</span>
<span class="fc" id="L92">        String encoding = executionContext.getMetaData().getFirstOrThrows(HttpConstants.ENCODING);</span>

<span class="fc" id="L94">        return ArrayUtils.addAll(</span>
<span class="fc" id="L95">                prefix.formatted(contentType).getBytes(Charset.forName(encoding)),</span>
<span class="fc" id="L96">                executionContext.getData().getContent().getByteArray());</span>
    }

    private List&lt;ContextPayload&gt; toContextPayloads(Collection&lt;MimeBodyPart&gt; mimeBodyParts, String encoding)
            throws MessagingException, IOException {
<span class="fc" id="L101">        List&lt;ContextPayload&gt; newContextPayloads = new ArrayList&lt;&gt;(mimeBodyParts.size());</span>
<span class="fc" id="L102">        int i = 0;</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">        for (MimeBodyPart mimeBodyPart : mimeBodyParts) {</span>
<span class="fc" id="L104">            ContextPayload contextPayload = new ContextPayload();</span>
<span class="fc" id="L105">            contextPayload.setContentType(mimeBodyPart.getContentType());</span>
<span class="fc" id="L106">            contextPayload.setEncoding(encoding);</span>

<span class="fc bfc" id="L108" title="All 2 branches covered.">            if (mimeBodyPart.getContent() instanceof ByteArrayInputStream byteArrayInputStream) {</span>
<span class="fc" id="L109">                contextPayload.setContent(PayloadContent.of(byteArrayInputStream.readAllBytes()));</span>
            } else {
<span class="fc" id="L111">                String bodyPartMimeType = EbxmlUtils.extractMimeType(mimeBodyPart.getContentType())</span>
<span class="fc" id="L112">                        .orElseThrow();</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                if (EbxmlUtils.isBinaryType(bodyPartMimeType)) {</span>
<span class="nc" id="L114">                    contextPayload.setContent(PayloadContent.of((byte[]) mimeBodyPart.getContent()));</span>
                } else {
<span class="fc" id="L116">                    contextPayload.setContent(PayloadContent.of(mimeBodyPart.getInputStream()));</span>
                }
            }

<span class="fc" id="L120">            mimeBodyPart.getAllHeaders().asIterator().forEachRemaining(header -&gt; contextPayload</span>
<span class="fc" id="L121">                    .getMetaData()</span>
<span class="fc" id="L122">                    .set(header.getName(), header.getValue()));</span>

<span class="fc" id="L124">            contextPayload.setContentId(ArrayUtils.get(mimeBodyPart.getHeader(HttpConstants.CONTENT_ID.getName()), 0));</span>
<span class="fc" id="L125">            contextPayload.setSequenceNumber(i++);</span>
<span class="fc" id="L126">            contextPayload.setSize(contextPayload.getContent().getSize());</span>
<span class="fc" id="L127">            newContextPayloads.add(contextPayload);</span>
<span class="fc" id="L128">        }</span>
<span class="fc" id="L129">        return newContextPayloads;</span>
    }

    @Override
    public List&lt;ParameterDefinition&gt; parameterDefinitions() {
<span class="fc" id="L134">        return List.of();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>